---
title: "Oxygen flux rate extractions "
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

## install packages if you dont already have them in your library
if (!require("devtools")) install.packages("devtools")
if (!require("furrr")) install.packages("furrr")
if (!require("future")) install.packages("future")
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("lubridate")) install.packages("lubridate")
if (!require("cowplot")) install.packages("cowplot")
if (!require("LoLinR")) install_github('colin-olito/LoLinR') 

## load libraries
library(devtools)
library(LoLinR)
library(tidyverse)
library(lubridate)
library(cowplot)
library(broom)
library(plotrix)
library(Hmisc)
library(rTPC)
library(nls.multstart)
library(emmeans)

## libraries for parallel processing
library(future)
library(furrr)
```

# Import data
```{r, warning = FALSE}
pr<-read_csv(file="output/p_r_rates/pr_curve_extracted_rates.csv")
sa<-read_csv(file="output/physiology/surface_area/surface_area.csv")
```

Add in surface area into pr data frame 
```{r}
pr$surface.area<-sa$surface.area.cm2[match(pr$sample_id, sa$sample_id)]
```

# Calculate P gross and PR ratio

Load in cell density to normalize to cell density. 

```{r}
sym<-read_csv(file="output/physiology/cell_density/symbiont_densities.csv")
```

Merge data and normalize rates to per cell and calculate P gross and PR ratio. 
```{r}
pr$cells.cm2<-sym$cells.cm2[match(pr$sample_id, sym$sample_id)]
hist(pr$cells.cm2)

pr_wide<-pr%>%
  select(Species, Lifestage, sample_id, Temp.Cat.x, micromol.cm2.h, surface.area, cells.cm2, Light_Value.x)%>%
  pivot_wider(names_from=Light_Value.x, values_from=micromol.cm2.h)%>%
  rename(LEDR=`0`, Pnet=`550`)%>%
  mutate(LEDR=if_else(LEDR>0, 0, LEDR))%>% #if no oxygen consumption was observed, add 0 for respiration value
  mutate(LEDR=LEDR*-1)%>%
  mutate(Pgross=Pnet+LEDR)%>%
  mutate(LEDR_cell=LEDR/cells.cm2)%>%
  mutate(Pnet_cell=Pnet/cells.cm2)%>%
  mutate(Pgross_cell=Pgross/cells.cm2)%>%
  rename(Temperature=Temp.Cat.x)%>%
  mutate(Temperature=as.factor(Temperature))%>%
  mutate(PR_ratio=Pgross/LEDR)
```

# View LEDR, Pnet, and Pgross by treatment 

Visualize LEDR
```{r}
ledr_plot<-pr_wide %>% ggplot(aes(x=Temperature, y=LEDR, colour = Lifestage))+
  geom_point(position=position_dodge(0.5))+
  facet_wrap(~Species, nrow=1)+
  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste("LEDR (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic();ledr_plot

#remove those with 0 respiration as this is not biologically possible 
ledr_plot<-pr_wide %>% filter(LEDR>0)%>% ggplot(aes(x=Temperature, y=LEDR, colour = Lifestage))+
  geom_point(position=position_dodge(0.5))+
  facet_wrap(~Species, nrow=1)+
  ylim(0, 2.5)+
  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste("LEDR (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic();ledr_plot

ggsave("figures/p_r_rates/LEDR_dots.png", ledr_plot, width = 8, height = 4)

# view by means 
ledr_plot_2<-pr_wide %>% 
  group_by(Species, Lifestage, Temperature)%>%
  filter(LEDR>0)%>%
  summarise(mean=mean(LEDR, na.rm=TRUE), se=sd(LEDR, na.rm=TRUE)/sqrt(length(LEDR)))%>%
  
  ggplot(aes(x=Temperature, y=mean, colour = Lifestage))+
  geom_point(aes(colour=Lifestage), position=position_dodge(0.5), size=2)+
  geom_errorbar(aes(ymin=(mean)-se, ymax=(mean)+se, group=Lifestage), color="gray", width=0.1, position=position_dodge(0.5))+
  geom_line(aes(group=Lifestage), linewidth=1.2, position=position_dodge(0.5))+
  facet_wrap(~Species, nrow=1)+
  ylim(0, 2)+
  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste("LEDR (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic();ledr_plot_2

ggsave("figures/p_r_rates/LEDR_means.png", ledr_plot_2, width = 8, height = 4)
```

Visualize Pnet
```{r}
#plot  values
pnet_plot<-pr_wide %>% ggplot(aes(x=Temperature, y=Pnet, colour = Lifestage))+
  geom_point(aes(), position=position_dodge(0.3))+
  facet_wrap(~Species, nrow=1)+
  #geom_text(aes(label=sample_id),hjust=0, vjust=0)+
  xlab(expression(bold("Temperature °C"))) +
  ylim(0, 3.1)+
  ylab(expression(bold(paste(P[Net], " (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic(); pnet_plot

ggsave("figures/p_r_rates/Pnet_dots.png", pnet_plot, width = 8, height = 4)

# view by means 
pnet_plot_2<-pr_wide %>% 
  group_by(Species, Lifestage, Temperature)%>%
  summarise(mean=mean(Pnet, na.rm=TRUE), se=sd(Pnet, na.rm=TRUE)/sqrt(length(Pnet)))%>%
  
  ggplot(aes(x=as.factor(Temperature), y=mean, colour = Lifestage))+
  geom_point(aes(colour=Lifestage), position=position_dodge(0.5), size=2)+
  geom_errorbar(aes(ymin=(mean)-se, ymax=(mean)+se, group=Lifestage), color="gray", width=0.1, position=position_dodge(0.5))+
  geom_line(aes(group=Lifestage), linewidth=1.2, position=position_dodge(0.5))+
  facet_wrap(~Species, nrow=1)+
  ylim(0, 3)+
  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste(P[Net], " (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic();pnet_plot_2

ggsave("figures/p_r_rates/Pnet_means.png", pnet_plot_2, width = 8, height = 4)
```

Visualize P gross
```{r}
#plot  values
pgross_plot<-pr_wide %>% ggplot(aes(x=Temperature, y=Pgross, colour = Lifestage))+
  geom_point(aes(), position=position_dodge(0.3))+
  facet_wrap(~Species, nrow=1)+
  #geom_text(aes(label=sample_id),hjust=0, vjust=0)+
  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste(P[Gross], " (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic(); pgross_plot

ggsave("figures/p_r_rates/Pgross_dots.png", pgross_plot, width = 8, height = 4)

# view by means 
pgross_plot_2<-pr_wide %>% 
  group_by(Species, Lifestage, Temperature)%>%
  summarise(mean=mean(Pgross, na.rm=TRUE), se=sd(Pgross, na.rm=TRUE)/sqrt(length(Pgross)))%>%
  
  ggplot(aes(x=as.factor(Temperature), y=mean, colour = Lifestage))+
  geom_point(aes(colour=Lifestage), position=position_dodge(0.5), size=2)+
  geom_errorbar(aes(ymin=(mean)-se, ymax=(mean)+se, group=Lifestage), color="gray", width=0.1, position=position_dodge(0.5))+
  geom_line(aes(group=Lifestage), linewidth=1.2, position=position_dodge(0.5))+
  facet_wrap(~Species, nrow=1)+
  ylim(0, 4.1)+
  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste(P[Gross], " (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic();pgross_plot_2

ggsave("figures/p_r_rates/Pgross_means.png", pgross_plot_2, width = 8, height = 4)
```

Visualize PR ratio
```{r}
#plot  values
pr_ratio_plot<-pr_wide %>% filter(LEDR>0) %>% filter(PR_ratio>0) %>% 
  ggplot(aes(x=Temperature, y=PR_ratio, colour = Lifestage))+
  geom_point(aes(), position=position_dodge(0.3))+
  facet_wrap(~Species, nrow=1)+
  #geom_text(aes(label=sample_id),hjust=0, vjust=0)+
  ylim(0,5)+
  geom_hline(yintercept=1, linetype="dashed")+
  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold("P:R Ratio"))) +
  theme_classic(); pr_ratio_plot

ggsave("figures/p_r_rates/PR_ratio_dots.png", pr_ratio_plot, width = 8, height = 4)

# view by means 
pr_ratio_plot_2<-pr_wide %>% 
  filter(PR_ratio>0) %>% 
  filter(LEDR>0)%>%
  group_by(Species, Lifestage, Temperature)%>%
  summarise(mean=mean(PR_ratio, na.rm=TRUE), se=sd(PR_ratio, na.rm=TRUE)/sqrt(length(PR_ratio)))%>%
  
  ggplot(aes(x=as.factor(Temperature), y=mean, colour = Lifestage))+
  geom_point(aes(colour=Lifestage), position=position_dodge(0.5), size=2)+
  geom_errorbar(aes(ymin=(mean)-se, ymax=(mean)+se, group=Lifestage), color="gray", width=0.1, position=position_dodge(0.5))+
  ylim(0,5)+
  geom_hline(yintercept=1, linetype="dashed")+
  geom_line(aes(group=Lifestage), linewidth=1.2, position=position_dodge(0.5))+
  facet_wrap(~Species, nrow=1)+
  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold("P:R Ratio"))) +
  theme_classic();pr_ratio_plot_2

ggsave("figures/p_r_rates/PR_ratio_means.png", pr_ratio_plot_2, width = 8, height = 4)
```

# Plot P and R with labels for individual observation for QCing

```{r}
#plot  values
pnet_samples<-pr_wide %>% ggplot(aes(x=Lifestage, y=Pnet, colour = Lifestage))+
  geom_point(position=position_jitterdodge(0.3))+
  facet_wrap(~Species, nrow=1)+
  geom_text(aes(label=sample_id),hjust=0, vjust=0, position=position_jitterdodge(0.3))+
  xlab(expression(bold("Lifestage"))) +
  ylab(expression(bold(paste(P[Gross], " (µmol ", O[2], " cm"^-2, "hr"^-1, ")")))) +
  theme_classic(); pnet_samples

ggsave("figures/p_r_rates/Pnet_samples.png", pnet_samples, width = 16, height = 12)
```

```{r}
#plot  values
pgross_samples<-pr_wide %>% ggplot(aes(x=Lifestage, y=Pgross, colour = Lifestage))+
  geom_point(position=position_jitterdodge(0.3))+
  facet_wrap(~Species, nrow=1)+
  geom_text(aes(label=sample_id),hjust=0, vjust=0, position=position_jitterdodge(0.3))+
  xlab(expression(bold("Lifestage"))) +
  ylab(expression(bold(paste(P[Gross], " (µmol ", O[2], " cm"^-2, "hr"^-1, ")")))) +
  theme_classic(); pgross_samples

ggsave("figures/p_r_rates/Pgross_samples.png", pgross_samples, width = 16, height = 12)
```

```{r}
#plot  values
ledr_samples<-pr_wide %>% ggplot(aes(x=Lifestage, y=LEDR, colour = Lifestage))+
  geom_point(position=position_jitterdodge(0.3))+
  facet_wrap(~Species, nrow=1)+
  geom_text(aes(label=sample_id),hjust=0, vjust=0, position=position_jitterdodge(0.3))+
  xlab(expression(bold("Lifestage"))) +
  ylab(expression(bold(paste("LEDR (µmol ", O[2], " cm"^-2, "hr"^-1, ")")))) +
  theme_classic(); ledr_samples

ggsave("figures/p_r_rates/LEDR_samples.png", ledr_samples, width = 16, height = 12)
```

Need to look into 0 observations and QC to make sure the slope extraction was correct. 

# Statistical tests on each metric 

Run ANOVAs on each metric 

Pgross
```{r}
model1<-aov(Pgross~Lifestage*Species*Temperature, data=pr_wide)
summary(model1)

emm<-emmeans(model1, ~Lifestage | Species)
pairs(emm)
```
Significant species x lifestage interaction on P gross. No effect of temperature. P gross is lower in POR recruits than adults. No difference in other species. 

LEDR
```{r}
model2<-aov(LEDR~Lifestage*Species*Temperature, data=pr_wide)
summary(model2)

emm<-emmeans(model2, ~Lifestage | Species)
pairs(emm)
```
Significant species x lifestage interaction. No effect of temperature. LEDR is higher in POR adults than recruits but not different between other species. 

Pnet
```{r}
model3<-aov(Pnet~Lifestage*Species*Temperature, data=pr_wide)
summary(model3)

emm<-emmeans(model2, ~Lifestage | Species)
pairs(emm)
```
Pnet is higher in POR adults than recruits but not different between other species. Almost an effect of temp but not significant.  

# View by recruit size 

View by size. 

Pgross
```{r}
pgross_plot_recruit<-pr_wide %>% filter(Lifestage=="Recruit") %>% 
  ggplot(aes(x=surface.area, y=Pgross, colour = Temperature))+
  geom_point(position=position_dodge(0.3), alpha=0.3)+
  facet_wrap(~Species, nrow=1, scales="free_x")+
  #geom_smooth(method="lm", aes(group=Temperature), se=FALSE)+
  geom_smooth(method="lm", aes(group=Species), se=FALSE, colour="black")+
  scale_colour_manual(values=c("blue2", "orange", "red3"))+

  xlab(expression(bold(paste("Recruit Surface Area (cm"^2, ")")))) +
  ylab(expression(bold(paste(P[Gross], " (µmol ", O[2], " cm"^-2, "hr"^-1, ")")))) +
  theme_classic()+
  ylim(0, 3.5)+
  theme(legend.position="none"); pgross_plot_recruit

ggsave("figures/p_r_rates/Pgross_recruit_size.png", pgross_plot_recruit, width = 6, height = 4)
```

Not a strong relationship from what I can see. 

LEDR
```{r}
ledr_plot_recruit<-pr_wide %>% filter(Lifestage=="Recruit") %>% filter(LEDR>0) %>%
  ggplot(aes(x=surface.area, y=LEDR, colour = Temperature))+
  geom_point(position=position_dodge(0.3), alpha=0.3)+
  facet_wrap(~Species, nrow=1, scales="free_x")+
  #geom_smooth(method="lm", aes(group=Temperature), se=FALSE)+
  geom_smooth(method="lm", aes(group=Species), se=FALSE, colour="black")+
  scale_colour_manual(values=c("blue2", "orange", "red3"))+

  xlab(expression(bold(paste("Recruit Surface Area (cm"^2, ")")))) +
  ylab(expression(bold(paste("LEDR (µmol ", O[2], " cm"^-2, "hr"^-1, ")")))) +
  theme_classic()+
  ylim(0, 1.75)+
  theme(legend.position="none"); ledr_plot_recruit

ggsave("figures/p_r_rates/LEDR_recruit_size.png", ledr_plot_recruit, width = 6, height = 4)
```

Maybe a negative relationship in POC and positive in POR? 

## Statistical tests 

Pgross by size 
```{r}
model4a<- pr_wide%>%
          filter(Lifestage=="Recruit")%>%
  
  aov(Pgross~surface.area*Species, data=.)

summary(model4a)
```
No effects. 

LEDR by size 
```{r}
model4b<- pr_wide%>%
          filter(LEDR>0)%>%
          filter(Lifestage=="Recruit")%>%
  
  aov(LEDR~surface.area*Species, data=.)

summary(model4b)
```
No effects. 

# Correlate P gross and LEDR 

Plot correlation between P and R
```{r}
corr1<-pr_wide%>%
  filter(LEDR>0)%>%
  
  ggplot(aes(x=LEDR, y=Pgross, colour = Temperature))+
  geom_point(position=position_dodge(0.3), alpha=0.3)+
  facet_wrap(~Species, nrow=1, scales="free_x")+
  #geom_smooth(method="lm", aes(group=Temp.Cat.x), se=FALSE)+
  geom_smooth(method="lm", aes(group=Species), se=FALSE, colour="black")+
  scale_colour_manual(values=c("blue2", "orange", "red3"))+

  xlab(expression(bold(paste("LEDR (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  ylab(expression(bold(paste(P[Gross], " (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic()+
  ylim(0, 5.5)+
  theme(legend.position="none"); corr1

ggsave("figures/p_r_rates/P_LEDR_correlation.png", corr1, width = 6, height = 4)
```

There is a strong correlation between LEDR and Pgross. 
```{r}
model5<-pr_wide%>%
  filter(LEDR>0)%>%
  aov(Pgross~LEDR*Species, data=.)

summary(model5)

cor.test(pr_wide$Pgross, pr_wide$LEDR, method="pearson")

```
The relationship between P and LEDR is strong. Correlation is r=0.9128 and p<0.001.  

# View metrics normalized to symbiont cell density 

Plot metrics per cell. Identify outliers 
```{r}
hist(pr_wide$Pgross_cell)
hist(pr_wide$LEDR_cell)
hist(pr_wide$Pnet_cell)
```

## P gross 

View individual observations. 
```{r}
cell_plot1<-pr_wide%>%
  filter(Pgross_cell<0.00003)%>%
  
  ggplot(aes(x=Temperature, y=Pgross_cell, colour = Lifestage))+
  geom_point(position=position_dodge(0.3), alpha=1)+
  facet_wrap(~Species, nrow=1, scales="free_x")+
  geom_smooth(method="loess", aes(group=Lifestage), se=FALSE)+
  #geom_smooth(method="lm", aes(group=Species), se=FALSE, colour="black")+

  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste(P[Gross], " (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic()+
  theme(legend.position="right"); cell_plot1

ggsave("figures/p_r_rates/Pgross_cell_dots.png", cell_plot1, width = 6, height = 4)
```

View mean observations. 
```{r}
cell_plot2<-pr_wide%>%
  filter(Pgross_cell<0.00003)%>%
  filter(!is.na(Pgross_cell))%>%
  group_by(Species, Lifestage, Temperature)%>%
  mutate(mean=mean(Pgross_cell, na.rm=TRUE), sd=sd(Pgross_cell, na.rm=TRUE), N=length(Pgross_cell), se=sd/sqrt(N))%>%
  
  ggplot(aes(x=Temperature, y=mean, colour = Lifestage, group=Lifestage))+
  geom_line(aes(group=Lifestage), colour="darkgray", linewidth=1, position=position_dodge(0.5))+
    geom_point(position=position_dodge(0.5), alpha=1, size=3)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), colour="black", width=0, position=position_dodge(0.5))+
  facet_wrap(~Species, nrow=1, scales="free_x")+

  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste(P[Gross], " (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic()+
  theme(legend.position="right"); cell_plot2

ggsave("figures/p_r_rates/Pgross_cell_means.png", cell_plot2, width = 6, height = 4)
```

Analyze Pgross per cell 

Run anova. 
```{r}
model6<-pr_wide%>%
  filter(Pgross_cell<0.00003)%>%
  filter(!is.na(Pgross_cell))%>%
  
  aov(Pgross_cell~Species*Lifestage*Temperature, data=.)

summary(model6)

emm<-emmeans(model6, ~Lifestage | Temperature | Species)
pairs(emm)
```
Interaction between species x lifestage x temperature and species x lifestage. Higher in POC recruits than adults. At 30C, POC recruit P gross is higher than adult P gross. Not different at other temperatures (almost at 33C). No other differences in other species. 

## LEDR per cell 

Plot LEDR per cell 

View individual observations. 
```{r}
cell_plot3<-pr_wide%>%
  filter(LEDR_cell<0.00002)%>%
  
  ggplot(aes(x=Temperature, y=LEDR_cell, colour = Lifestage))+
  geom_point(position=position_dodge(0.3), alpha=1)+
  facet_wrap(~Species, nrow=1, scales="free_x")+
  geom_smooth(method="loess", aes(group=Lifestage), se=FALSE)+
  #geom_smooth(method="lm", aes(group=Species), se=FALSE, colour="black")+

  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste("LEDR (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic()+
  theme(legend.position="none"); cell_plot3

ggsave("figures/p_r_rates/LEDR_cell_dots.png", cell_plot3, width = 6, height = 4)
```

View mean observations. 
```{r}
cell_plot4<-pr_wide%>%
  filter(LEDR_cell<0.00002)%>%
  filter(!is.na(LEDR_cell))%>%
  group_by(Species, Lifestage, Temperature)%>%
  mutate(mean=mean(LEDR_cell, na.rm=TRUE), sd=sd(LEDR_cell, na.rm=TRUE), N=length(LEDR_cell), se=sd/sqrt(N))%>%
  
  ggplot(aes(x=Temperature, y=mean, colour = Lifestage, group=Lifestage))+
  geom_line(aes(group=Lifestage), colour="darkgray", linewidth=1, position=position_dodge(0.5))+
    geom_point(position=position_dodge(0.5), alpha=1, size=3)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), colour="black", width=0, position=position_dodge(0.5))+
  facet_wrap(~Species, nrow=1, scales="free_x")+

  #geom_smooth(method="lm", aes(group=Species), se=FALSE, colour="black")+

  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste("LEDR (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic()+
  theme(legend.position="none"); cell_plot4

ggsave("figures/p_r_rates/LEDR_cell_means.png", cell_plot4, width = 6, height = 4)
```

Analyze LEDR per cell 

```{r}
model7<-pr_wide%>%
  filter(LEDR_cell<0.00002)%>%
  
  aov(LEDR_cell~Species*Lifestage*Temperature, data=.)

summary(model7)
```
No difference in LEDR normalized to cells. Almost an effect of temp but not really. 

## P net per cell 

View individual observations. 
```{r}
cell_plot5<-pr_wide%>%
  filter(Pnet_cell<0.00002)%>%
  
  ggplot(aes(x=Temperature, y=Pnet_cell, colour = Lifestage))+
  geom_point(position=position_dodge(0.3), alpha=1)+
  facet_wrap(~Species, nrow=1, scales="free_x")+
  geom_smooth(method="loess", aes(group=Lifestage), se=FALSE)+
  #geom_smooth(method="lm", aes(group=Species), se=FALSE, colour="black")+

  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste(P[Net], " (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic()+
  theme(legend.position="none"); cell_plot5

ggsave("figures/p_r_rates/Pnet_cell_dots.png", cell_plot5, width = 6, height = 4)
```

View mean observations. 
```{r}
cell_plot6<-pr_wide%>%
  filter(Pnet_cell<0.00002)%>%
  filter(!is.na(Pnet_cell))%>%
  group_by(Species, Lifestage, Temperature)%>%
  mutate(mean=mean(Pnet_cell, na.rm=TRUE), sd=sd(Pnet_cell, na.rm=TRUE), N=length(Pnet_cell), se=sd/sqrt(N))%>%
  
  ggplot(aes(x=Temperature, y=mean, colour = Lifestage, group=Lifestage))+
  geom_line(aes(group=Lifestage), colour="darkgray", linewidth=1, position=position_dodge(0.5))+
    geom_point(position=position_dodge(0.5), alpha=1, size=3)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), colour="black", width=0, position=position_dodge(0.5))+
  facet_wrap(~Species, nrow=1, scales="free_x")+

  xlab(expression(bold("Temperature °C"))) +
  ylab(expression(bold(paste(P[Net], " (µmol ", O[2], " cell"^-1, "hr"^-1, ")")))) +
  theme_classic()+
  theme(legend.position="none"); cell_plot6

ggsave("figures/p_r_rates/Pnet_cell_means.png", cell_plot6, width = 6, height = 4)
```

Analyze Pnet per cell 

Run anova. 
```{r}
model8<-pr_wide%>%
  filter(Pnet_cell<0.00002)%>%
  filter(!is.na(Pnet_cell))%>%
  
  aov(Pnet_cell~Species*Lifestage*Temperature, data=.)

summary(model8)

emm<-emmeans(model8, ~Lifestage | Species)
pairs(emm)
```
There is a lifestage effect and species effect. Recruit Pnet is higher in recruits than adults. No difference in other species. 
