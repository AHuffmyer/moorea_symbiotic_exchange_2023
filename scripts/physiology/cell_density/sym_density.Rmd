---
title: "Symbiont density analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
## install packages if you dont already have them
if (!require("tidyverse")) install.packages("tidyverse")

# load packages
library(tidyverse)
```

# Import data
```{r}
# Cell count data
sym_counts <- read_csv("data/physiology/cell_density/cells.csv")

# Surface area data
sa <- read.csv("output/physiology/surface_area/surface_area.csv") 

# Tissue homogenate volume data
homog_vols <- read_csv("data/physiology/homog_vols.csv") %>% select(sample_id, total_slurry_ml, sym_vol_ml, host_vol_ml, resuspended_sym_vol_ml)

# Coral sample metadata
metadata <- read_csv("data/p_r_rates/pr_sample_metadata.csv") %>% select(sample_id, Species, Lifestage, Temp.Cat) %>% filter(!str_detect(sample_id, "^BK"))

# Join homogenate volumes and surface area with sample metadata
metadata <- full_join(metadata, homog_vols) %>%
  full_join(sa) %>% filter(!is.na(Species))
```


# Calculate cells per square centimeter
```{r}
# Calculate mean counts for each sample
sym_counts <- sym_counts %>%
  select(sample_id, squares_counted, matches("count[0-6]")) %>%
  gather("rep", "count", -sample_id, -squares_counted) %>%
  group_by(sample_id, squares_counted) %>%
  summarise(mean_count = mean(count, na.rm = TRUE))

# Join mean counts with sample metadata
sym_counts <- full_join(sym_counts, metadata)


# homogenate volume = total tissue
# sym aliquot volume = total tissue from which cells were taken
# sym resuspended volume = dilution of cells from total pellet 

#count * 10000 / squares counted = cells per ml
#cells per ml * resuspended volume = total cells in aliquot
#total cells in slurry = total cells * (total slurry / aliquot volume)
# cells per unit sa = total cells in slurry / sa 

# Normalize counts by homogenate volume and surface area

sym_counts <- sym_counts %>%
  mutate(cells.ml = mean_count * 10000 / squares_counted,
         aliquot.cells = cells.ml * resuspended_sym_vol_ml, 
         total.cells = aliquot.cells * (total_slurry_ml/sym_vol_ml),
         cells.cm2 = total.cells / surface.area.cm2)
```

# Plot data
```{r}
sym_counts %>%

  ggplot(aes(x = Lifestage, y = cells.cm2 / 10^6), colour=as.factor(Temp.Cat)) +
  labs(x = "",y = "Cell Density (Cells/cm2 * 10^6)") +
  facet_wrap(~ Species) +
  geom_jitter(aes(colour=as.factor(Temp.Cat)),width = 0.1) +                                            # Plot all points
  stat_summary(fun.data = mean_cl_normal, fun.args = list(mult = 1),    # Plot standard error
               geom = "errorbar", color = "black", width = 0.1) +
  stat_summary(fun = mean, geom = "point", color = "black")+
  scale_colour_manual(values=c("blue2", "orange", "darkred"))+
  theme_classic()# Plot mean
```

Generate final figures 

Plot with mean and standard error by lifestage and species. 
```{r}

# Calculate the number of rows including NAs
rows_with_na <- nrow(sym_counts)
print(rows_with_na)  # Output: 4

# Calculate the number of rows excluding NAs
rows_without_na <- length(na.omit(sym_counts$cells.cm2))

print(rows_without_na)  # Output: 3

plot1<-sym_counts %>%
    group_by(Species, Lifestage)%>%
    dplyr::summarise(mean=mean(cells.cm2, na.rm=TRUE), sd=sd(cells.cm2, na.rm=TRUE), N=length(na.omit(sym_counts$cells.cm2)), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = Lifestage, y = mean / 10^6, group=Lifestage)) +
    facet_grid(~Species)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=Lifestage), size=6, position = position_dodge(0.4), color="darkgray") + 
    geom_errorbar(aes(ymin=(mean/ 10^6)-(se/ 10^6), ymax=(mean/ 10^6)+(se/ 10^6), group=Lifestage), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Temperature") + 
    ylab(expression(bold(paste("Cell Density (10"^6, "cells cm"^-2, ")")))) +
    ggtitle("")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      title = element_text(size=14, face="bold")
      ); plot1

ggsave("figures/physiology/cell_density/cells_means.png", plot1, dpi=300, w=4, h=4, units="in")
```

Plot by individual observation with colour by temperature exposure. 
```{r}
plot2<-sym_counts %>%
    mutate(Temp.Cat=as.factor(Temp.Cat))%>%
    
    ggplot(., aes(x = Lifestage, y = cells.cm2 / 10^6, group=Lifestage, color=Temp.Cat)) +
    facet_grid(~Species)+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=Lifestage), size=3, position = position_jitterdodge(0.5)) + 
    xlab("Temperature") + 
    ylab(expression(bold(paste("Cell Density (10"^6, "cells cm"^-2, ")")))) +
    scale_color_manual(values=c("blue2", "orange", "red3"))+
    ggtitle("")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      title = element_text(size=14, face="bold")
      ); plot2

ggsave("figures/physiology/cell_density/cells_dots.png", plot2, dpi=300, w=4, h=4, units="in")
```

# Run ANOVA tests 

```{r}
model1<-sym_counts%>%
  
  aov(cells.cm2~Temp.Cat*Species*Lifestage, data=.)

summary(model1)
```

No effect of temp, run only with species and lifesetage. 
```{r}
model2<-sym_counts%>%
  
  aov(cells.cm2~Species*Lifestage, data=.)

summary(model2)

emm<-emmeans(model2, ~Lifestage | Species)
pairs(emm)
```

There is an interaction of species and lifestage and each on its own. 

Recruits have lower cell density than adults in POC and POR species. No difference in Acropora. 

Output data to file.  

```{r}
sym_counts %>%
  select(sample_id, Lifestage, Species, Temp.Cat, cells.cm2) %>%
  write_csv(file = "output/physiology/cell_density/symbiont_densities.csv")

```
