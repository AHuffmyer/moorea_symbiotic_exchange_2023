---
title: Moorea 2023 metabolomics analysis 
author: "AS Huffmyer"
date: '2025'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

This script analyzes stable isotope metabolomic data for the 2023 Moorea symbiotic nutritional exchange project.  

# Set Up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("vegan" %in% rownames(installed.packages()) == 'FALSE') install.packages('vegan') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("factoextra" %in% rownames(installed.packages()) == 'FALSE') install.packages('factoextra') 
if ("ggfortify" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggfortify') 
if ("naniar" %in% rownames(installed.packages()) == 'FALSE') install.packages('naniar') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
if ("mixOmics" %in% rownames(installed.packages()) == 'FALSE') BiocManager::install("mixOmics") 
if ("RVAideMemoire" %in% rownames(installed.packages()) == 'FALSE') install.packages('RVAideMemoire') 
if ("VennDiagram" %in% rownames(installed.packages()) == 'FALSE') install.packages('VennDiagram') 
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom') 
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("readxl" %in% rownames(installed.packages()) == 'FALSE') install.packages('readxl') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 
if ("data.table" %in% rownames(installed.packages()) == 'FALSE') install.packages('data.table') 

#load packages
library("ggplot2")
library('vegan')
library('factoextra')
library('ggfortify')
library('naniar')
library('cowplot')
library("mixOmics")
library("tidyverse")
library("RVAideMemoire")
library("VennDiagram")
library("broom")
library("lme4")
library("lmerTest")
library("readxl")
library("emmeans")
library("multcomp")
library("data.table")
```

# Load Data 

Load positive polarity data.  
```{r}
#load pool size quantified as total intensity for each metabolite, this dataset will require median normalization
pos_pool_size<-read_xlsx("data/isotopes/positive/Peaks_Pos.xlsx", sheet="Pool Size")

#load per atom basis for labeling proportions, this dataset is proportion data, so no normalization is necessary
pos_enrichment<-read_xlsx("data/isotopes/positive/Peaks_Pos.xlsx", sheet="Enrichment")

#load proportion labeling by Number Carbons Labeled, this dataset is proportion data, so no normalization is necessary
pos_fractions<-read_csv("data/isotopes/positive/Fractions.csv")
```

Load in negative polarity data. 
```{r}
#load pool size quantified as total intensity for each metabolite, this dataset will require median normalization
neg_pool_size<-read_xlsx("data/isotopes/negative/Peaks_Neg.xlsx", sheet="Pool Size")

#load per atom basis for labeling proportions, this dataset is proportion data, so no normalization is necessary
neg_enrichment<-read_xlsx("data/isotopes/negative/Peaks_Neg.xlsx", sheet="Enrichment")

#load proportion labeling by Number Carbons Labeled, this dataset is proportion data, so no normalization is necessary
neg_fractions<-read_csv("data/isotopes/negative/Fractions.csv")
```

95 compounds in the negative dataset and 78 compounds in the positive dataset.  

Check for overlap in compounds between positive and negative. 

```{r}
intersect(pos_pool_size$Compound, neg_pool_size$Compound)
setdiff(pos_pool_size$Compound, neg_pool_size$Compound)
setdiff(neg_pool_size$Compound, pos_pool_size$Compound)
```

We have 52 compounds that are in both data sets. 

# Prepare pool size data 

## Normalization 

### Positive data 

```{r}
str(pos_pool_size)
```

Normalize pool size to the sample median to account for any variation in the number of larvae across samples. 
```{r}
pos_pool_size <- pos_pool_size %>%
  mutate(across(`12C_Ctrl_Acropora_unlabeled_1`:`13C_Recruit_Pocillopora_dark_1`, ~ .x / median(.x, na.rm = TRUE))) #normalize the intensity values to the columns median to account for any variation in larval number in each sample 
```

```{r}
pos_pool_size<-pos_pool_size%>%
  select(!starts_with("Blank"))
```

Mutate the data to be in long rather than wide format and keep only relevant columns.  

```{r}
pos_pool_size <- pos_pool_size %>% 
  pivot_longer(names_to = "sample", values_to="intensity.norm", `12C_Ctrl_Acropora_unlabeled_1`:`13C_Recruit_Pocillopora_dark_1`)%>%
  select(c(Compound, sample, intensity.norm))

head(pos_pool_size)
```

Add metadata column with isotope, treatment, tank, and tube ID. 
```{r}
pos_pool_size<-pos_pool_size%>%
  separate(sample, c("isotope", "lifestage", "species", "treatment","rep"), sep="_", remove = FALSE)

#convert to factors 
pos_pool_size$isotope<-as.factor(pos_pool_size$isotope)
pos_pool_size$lifestage<-as.factor(pos_pool_size$lifestage)
pos_pool_size$species<-as.factor(pos_pool_size$species)
pos_pool_size$treatment<-as.factor(pos_pool_size$treatment)
pos_pool_size$rep<-as.factor(pos_pool_size$rep)
pos_pool_size$Compound<-as.factor(pos_pool_size$Compound)
```

Check distribution of data.  
```{r}
hist(pos_pool_size$intensity.norm)
hist(log(1+pos_pool_size$intensity.norm))
```

Since distribution is very skewed, add log normalized column. 
```{r}
pos_pool_size$log.intensity.norm<-log(1+pos_pool_size$intensity.norm)
```

Clean metabolite names and remove standards.  

Clean any names that have (+HAc), rename to just include the metabolite name.  

```{r, echo=FALSE, results=FALSE}
levels(pos_pool_size$Compound)
length(levels(pos_pool_size$Compound)) #we have 78 metabolites in our dataset 
```

### Negative data 

```{r}
str(neg_pool_size)
```

Normalize pool size to the sample median to account for any variation in the number of larvae across samples. 
```{r}
neg_pool_size <- neg_pool_size %>%
  mutate(across(`12C_Ctrl_Acropora_unlabeled_1`:`13C_Recruit_Pocillopora_dark_1`, ~ .x / median(.x, na.rm = TRUE))) #normalize the intensity values to the columns median to account for any variation in larval number in each sample 
```

```{r}
neg_pool_size<-neg_pool_size%>%
  select(!starts_with("Blank"))
```

Mutate the data to be in long rather than wide format and keep only relevant columns.  

```{r}
neg_pool_size <- neg_pool_size %>% 
  pivot_longer(names_to = "sample", values_to="intensity.norm", `12C_Ctrl_Acropora_unlabeled_1`:`13C_Recruit_Pocillopora_dark_1`)%>%
  select(c(Compound, sample, intensity.norm))

head(neg_pool_size)
```

Add metadata column with isotope, treatment, tank, and tube ID. 
```{r}
neg_pool_size<-neg_pool_size%>%
  separate(sample, c("isotope", "lifestage", "species", "treatment","rep"), sep="_", remove = FALSE)

#convert to factors 
neg_pool_size$isotope<-as.factor(neg_pool_size$isotope)
neg_pool_size$lifestage<-as.factor(neg_pool_size$lifestage)
neg_pool_size$species<-as.factor(neg_pool_size$species)
neg_pool_size$treatment<-as.factor(neg_pool_size$treatment)
neg_pool_size$rep<-as.factor(neg_pool_size$rep)
neg_pool_size$Compound<-as.factor(neg_pool_size$Compound)
```

Check distribution of data.  
```{r}
hist(neg_pool_size$intensity.norm)
hist(log(1+neg_pool_size$intensity.norm))
```

Since distribution is very skewed, add log normalized column. 
```{r}
neg_pool_size$log.intensity.norm<-log(1+neg_pool_size$intensity.norm)
```

Clean metabolite names and remove standards.  

```{r, echo=FALSE, results=FALSE}
levels(neg_pool_size$Compound)
length(levels(neg_pool_size$Compound)) #we have 95 metabolites in our dataset 

neg_pool_size<-neg_pool_size%>%
  mutate(Compound = str_remove(Compound, pattern=fixed(' (+HAc)')))%>% #rename any with +HAc to remove the +HAc
  mutate(Compound = as.factor(Compound))

neg_pool_size<- droplevels(neg_pool_size)
length(levels(neg_pool_size$Compound))
levels(neg_pool_size$Compound) #names are now cleaned
```

## Reconcile overlap between data sets and combine 

```{r}
intersect(pos_pool_size$Compound, neg_pool_size$Compound)

str(pos_pool_size)
str(neg_pool_size)
```

There are 53 compounds represented in both data sets. Display the mean concentration of each compound and select the polarity with the highest concentration.  

Add a polarity column and combine datasets. 

```{r}
pos_pool_size <- pos_pool_size %>%
  mutate(polarity = "pos")

levels(pos_pool_size$Compound)

neg_pool_size <- neg_pool_size %>%
  mutate(polarity = "neg")

levels(neg_pool_size$Compound)

all_polarities <- full_join(pos_pool_size, neg_pool_size)

levels(all_polarities$Compound)

setdiff(neg_pool_size$Compound, all_polarities$Compound)
setdiff(all_polarities$Compound, neg_pool_size$Compound)
setdiff(all_polarities$Compound, pos_pool_size$Compound)
setdiff(pos_pool_size$Compound, all_polarities$Compound)
```

Calculate mean signal for each metabolite from normalized intensity values. 
```{r}
compound_by_polarity <- all_polarities %>%
  group_by(Compound, polarity) %>%
  summarise(
    mean_intensity = mean(intensity.norm, na.rm = TRUE),
    .groups = "drop"
  )
```

Select the polarity with the highest intensity. 
```{r}
compound_choice <- compound_by_polarity %>%
  group_by(Compound) %>%
  slice_max(mean_intensity, n = 1, with_ties = FALSE) %>%
  ungroup()
```

View a list of which value was selected. 
```{r}
metabolite_polarity_reference <- compound_choice %>%
  arrange(Compound)

pos_list<-metabolite_polarity_reference%>%filter(polarity=="pos")%>%droplevels()%>%pull(Compound)
pos_list
#60 from positive 

neg_list<-metabolite_polarity_reference%>%filter(polarity=="neg")%>%droplevels()%>%pull(Compound)
neg_list

intersect(pos_list, neg_list)
setdiff(pos_list, neg_list)
setdiff(neg_list, pos_list)
#60 from negative, no overlap 
```

Combine all 
```{r}
merged_metabolites <- all_polarities %>%
  inner_join(
    compound_choice %>% select(Compound, polarity),
    by = c("Compound", "polarity")
  )

merged_metabolites
levels(merged_metabolites$Compound)
```

We have 120 total compounds. 

We will use the lists we made to select polarities for the other data sets as well (enrichment and fractions).  



# Prepare enrichment data 

We do not need to perform normalization as these are proportion data.  

```{r}
str(pos_enrichment)
str(neg_enrichment)
```

## Prepare metadata 

### Positive data 

```{r}
pos_enrichment<-pos_enrichment%>%
  select(!starts_with("Blank"))
```

Mutate the data to be in long rather than wide format and keep only relevant columns.  

```{r}
pos_enrichment <- pos_enrichment %>% 
  pivot_longer(names_to = "sample", values_to="enrichment", `12C_Ctrl_Acropora_unlabeled_1`:`13C_Recruit_Pocillopora_dark_1`)%>%
  select(c(Compound, sample, enrichment))

head(pos_enrichment)
```

Add metadata column with isotope, treatment, tank, and tube ID. 
```{r}
pos_enrichment<-pos_enrichment%>%
  separate(sample, c("isotope", "lifestage", "species", "treatment","rep"), sep="_", remove = FALSE)

#convert to factors 
pos_enrichment$isotope<-as.factor(pos_enrichment$isotope)
pos_enrichment$lifestage<-as.factor(pos_enrichment$lifestage)
pos_enrichment$species<-as.factor(pos_enrichment$species)
pos_enrichment$treatment<-as.factor(pos_enrichment$treatment)
pos_enrichment$rep<-as.factor(pos_enrichment$rep)
pos_enrichment$Compound<-as.factor(pos_enrichment$Compound)
```

Check compound names. 

```{r}
levels(pos_enrichment$Compound)
```

All are clean. 78 total compounds. 

Check distribution of data.  
```{r}
hist(pos_enrichment$enrichment)
```

Bound between 0 and 1 as expected.  

```{r}
str(pos_enrichment)
```

### Negative data 

```{r}
neg_enrichment<-neg_enrichment%>%
  select(!starts_with("Blank"))
```

Mutate the data to be in long rather than wide format and keep only relevant columns.  

```{r}
neg_enrichment <- neg_enrichment %>% 
  pivot_longer(names_to = "sample", values_to="enrichment", `12C_Ctrl_Acropora_unlabeled_1`:`13C_Recruit_Pocillopora_dark_1`)%>%
  select(c(Compound, sample, enrichment))

head(neg_enrichment)
```

Add metadata column with isotope, treatment, tank, and tube ID. 
```{r}
neg_enrichment<-neg_enrichment%>%
  separate(sample, c("isotope", "lifestage", "species", "treatment","rep"), sep="_", remove = FALSE)

#convert to factors 
neg_enrichment$isotope<-as.factor(neg_enrichment$isotope)
neg_enrichment$lifestage<-as.factor(neg_enrichment$lifestage)
neg_enrichment$species<-as.factor(neg_enrichment$species)
neg_enrichment$treatment<-as.factor(neg_enrichment$treatment)
neg_enrichment$rep<-as.factor(neg_enrichment$rep)
neg_enrichment$Compound<-as.factor(neg_enrichment$Compound)
```

Check compound names. 

```{r}
levels(neg_enrichment$Compound)
length(levels(neg_enrichment$Compound)) #we have 95 metabolites in our dataset 

neg_enrichment<-neg_enrichment%>%
  mutate(Compound = str_remove(Compound, pattern=fixed(' (+HAc)')))%>% #rename any with +HAc to remove the +HAc
  mutate(Compound = as.factor(Compound))

neg_enrichment<- droplevels(neg_enrichment)
length(levels(neg_enrichment$Compound))
levels(neg_enrichment$Compound) #names are now cleaned
```

All are clean. 95 total compounds. 

Check distribution of data.  
```{r}
hist(neg_enrichment$enrichment)
```

Bound between 0 and 1 as expected.  

```{r}
str(neg_enrichment)
```

## Reconcile overlap between data sets and combine 

```{r}
intersect(pos_enrichment$Compound, neg_enrichment$Compound)

str(pos_enrichment)
str(neg_enrichment)
```

There are 53 compounds represented in both data sets. Select representatives from the lists we made above for pool size.  

```{r}
pos_enrichment<-pos_enrichment%>%
  filter(Compound %in% pos_list)

neg_enrichment<-neg_enrichment%>%
  filter(Compound %in% neg_list)

merged_enrichment<-bind_rows(pos_enrichment, neg_enrichment)
levels(merged_enrichment$Compound)
```

There are 120 total compounds as expected.  

# Prepare fraction data 

We do not need to perform normalization as these are proportion data.  

```{r}
str(pos_fractions)
str(neg_fractions)
```

Replace dashes with underscores in column names. 

```{r}
pos_fractions <- pos_fractions %>%
  rename_with(~ str_replace_all(.x, "-", "_"))

neg_fractions <- neg_fractions %>%
  rename_with(~ str_replace_all(.x, "-", "_"))
```

## Prepare metadata 

### Positive data 

```{r}
pos_fractions<-pos_fractions%>%
  select(!starts_with("Blank"))
```

Mutate the data to be in long rather than wide format and keep only relevant columns.  

```{r}
pos_fractions <- pos_fractions %>% 
  pivot_longer(names_to = "sample", values_to="enrichment", `12C_Ctrl_Acropora_unlabeled_1`:`13C_Recruit_Pocillopora_dark_1`)%>%
  select(c(Compound, Label, sample, enrichment))

head(pos_fractions)
```

Add metadata column with isotope, treatment, tank, and tube ID. 
```{r}
pos_fractions<-pos_fractions%>%
  separate(sample, c("isotope", "lifestage", "species", "treatment","rep"), sep="_", remove = FALSE)

#convert to factors 
pos_fractions$isotope<-as.factor(pos_fractions$isotope)
pos_fractions$lifestage<-as.factor(pos_fractions$lifestage)
pos_fractions$species<-as.factor(pos_fractions$species)
pos_fractions$treatment<-as.factor(pos_fractions$treatment)
pos_fractions$rep<-as.factor(pos_fractions$rep)
pos_fractions$Compound<-as.factor(pos_fractions$Compound)
```

Check compound names. 

```{r}
levels(pos_fractions$Compound)
```

All are clean. 78 total compounds. 

Check distribution of data.  
```{r}
hist(pos_fractions$enrichment)
```

Bound between 0 and 1 as expected.  

```{r}
str(pos_fractions)
```

### Negative data 

```{r}
neg_fractions<-neg_fractions%>%
  select(!starts_with("Blank"))
```

Mutate the data to be in long rather than wide format and keep only relevant columns.  

```{r}
neg_fractions <- neg_fractions %>% 
  pivot_longer(names_to = "sample", values_to="enrichment", `12C_Ctrl_Acropora_unlabeled_1`:`13C_Recruit_Pocillopora_dark_1`)%>%
  select(c(Compound, Label, sample, enrichment))

head(neg_fractions)
```

Add metadata column with isotope, treatment, tank, and tube ID. 
```{r}
neg_fractions<-neg_fractions%>%
  separate(sample, c("isotope", "lifestage", "species", "treatment","rep"), sep="_", remove = FALSE)

#convert to factors 
neg_fractions$isotope<-as.factor(neg_fractions$isotope)
neg_fractions$lifestage<-as.factor(neg_fractions$lifestage)
neg_fractions$species<-as.factor(neg_fractions$species)
neg_fractions$treatment<-as.factor(neg_fractions$treatment)
neg_fractions$rep<-as.factor(neg_fractions$rep)
neg_fractions$Compound<-as.factor(neg_fractions$Compound)
```

Check compound names. 

```{r}
levels(neg_fractions$Compound)
```

95 total compounds. 

Check distribution of data.  
```{r}
hist(neg_fractions$enrichment)
```

Bound between 0 and 1 as expected.  

```{r}
str(neg_fractions)
```

Check compound names. 

```{r}
levels(neg_fractions$Compound)
length(levels(neg_fractions$Compound)) #we have 95 metabolites in our dataset 

neg_fractions<-neg_fractions%>%
  mutate(Compound = str_remove(Compound, pattern=fixed(' (+HAc)')))%>% #rename any with +HAc to remove the +HAc
  mutate(Compound = as.factor(Compound))

neg_fractions<- droplevels(neg_fractions)
length(levels(neg_fractions$Compound))
levels(neg_fractions$Compound) #names are now cleaned
```

## Reconcile overlap between data sets and combine 

```{r}
intersect(pos_fractions$Compound, neg_fractions$Compound)

str(pos_fractions)
str(neg_fractions)
```

There are 53 compounds represented in both data sets. Select representatives from the lists we made above for pool size.  

```{r}
pos_fractions<-pos_fractions%>%
  filter(Compound %in% pos_list)

neg_fractions<-neg_fractions%>%
  filter(Compound %in% neg_list)

merged_fractions<-bind_rows(pos_fractions, neg_fractions)
levels(merged_fractions$Compound)
```

There are 120 total compounds as expected.  

# Carbon metabolism: Glucose, G6P, F6P, pyruvate, a-ketoglutarate, fructose, lactate

## Pool size 

Subset to desired compounds 

```{r}
carbon_list<-c("Glucose", "Glucose-6-phosphate", "Fructose-6-phosphate", "Pyruvate", "a-ketoglutarate", "Fructose", "Lactate")
```

```{r}
carbon<-merged_metabolites%>%
  filter(Compound %in% carbon_list)

head(carbon)
```

Filter out controls and blanks for now. 
```{r}
carbon<-carbon%>%
  filter(!isotope=="12C")%>%
  filter(!lifestage=="Blank")%>%
  filter(!lifestage=="Ctrl")%>%
  filter(!treatment=="dark")
```

Plot

```{r}
plot1<-carbon%>%
         
  ggplot(., aes(y=log.intensity.norm, x=treatment, color=lifestage)) + 
  facet_wrap(~Compound*species, scales="free")+
  geom_boxplot(position=position_dodge(0.8))+
  geom_point(position=position_dodge(0.8))+
  theme_classic()+
  xlab("Temperature")+
  ylab("log(Normalized Pool Size)")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot1
```

Run test using linear models. 

```{r}
results_acropora <- carbon %>%
  filter(species == "Acropora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(log.intensity.norm ~ treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term == "treatment") %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(p_adj_fdr)

results_acropora

```

No effect of treatment on Acropora metabolites. 

```{r}
results_pocillopora <- carbon %>%
  filter(species == "Pocillopora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(log.intensity.norm ~ treatment*lifestage, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term %in% c("treatment", "lifestage", "treatment:lifestage")) %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(Compound)%>%
  filter(p_adj_fdr<0.05)

results_pocillopora

```

Glucose is affected by treatment in Pocillopora. a-ketoglutarate (lower in larvae), fructose (lower in larvae), glucose-6-phosphate (higher in larvae), lactate (higher in larvae), and pyruvate (higher in larvae) are affected by lifestage.

Run test by group. 

```{r}
results <- carbon %>%
  mutate(group=paste0(species, "-", lifestage))%>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(log.intensity.norm ~ group*treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term %in% c("group", "treatment", "group:treatment")) %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(Compound)%>%
  filter(p_adj_fdr<0.05)

results

```

### Plot glucose only 

```{r}
plot_glucose<-carbon%>%
  filter(Compound=="Glucose")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(log.intensity.norm, na.rm=TRUE), se=sd(log.intensity.norm, na.rm=TRUE)/length(log.intensity.norm))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Glucose Concentration")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_glucose

ggsave(filename="figures/isotopes/glucose_concentration.png", plot_glucose, width=6, height=5)
```

### Plot pyruvate only 

```{r}
plot_pyruvate<-carbon%>%
  filter(Compound=="Pyruvate")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(log.intensity.norm, na.rm=TRUE), se=sd(log.intensity.norm, na.rm=TRUE)/length(log.intensity.norm))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Pyruvate Concentration")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_pyruvate

ggsave(filename="figures/isotopes/pyruvate_concentration.png", plot_pyruvate, width=6, height=5)
```

## Enrichment

Subset to desired compounds 

```{r}
carbon2<-merged_enrichment%>%
  filter(Compound %in% carbon_list)

head(carbon2)
```

Compare glucose enrichment between light and dark conditions. 

```{r}
plot_dark<-merged_enrichment%>%
  filter(Compound=="Glucose")%>%
  filter(!lifestage=="Blank")%>%
  filter(!treatment=="unlabeled")%>%
  filter(!lifestage=="Ctrl")%>%
  filter(treatment %in% c("27", "dark"))%>%
  
  group_by(species, lifestage, treatment)%>%
  summarise(mean=mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/length(enrichment))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, fill=species, pattern=lifestage)) + 
  facet_wrap(~lifestage)+
  geom_bar(stat="identity", position=position_dodge(0.8))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.8), width=0)+
  scale_color_manual(values=c("orange", "purple3"))+
  scale_fill_manual(values=c("orange", "purple3"))+
  theme_classic()+
  xlab("Treatment")+
  ylab("Enrichment")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot_dark

ggsave(filename="figures/isotopes/dark_comparison.png", plot_dark, width=6, height=5)
```


Filter out controls and blanks for now. 
```{r}
carbon2<-carbon2%>%
  filter(!isotope=="12C")%>%
  filter(!lifestage=="Blank")%>%
  filter(!lifestage=="Ctrl")%>%
  filter(!treatment=="dark")
```

Plot

```{r}
plot2<-carbon2%>%
         
  ggplot(., aes(y=enrichment, x=treatment, color=lifestage)) + 
  facet_wrap(~Compound*species, scales="free")+
  geom_boxplot(position=position_dodge(0.8))+
  geom_point(position=position_dodge(0.8))+
  scale_fill_manual(values=c("gray", "purple"))+
  theme_classic()+
  xlab("Temperature")+
  ylab("Enrichment")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot2
```

Run test using linear models. 

```{r}
results_acropora <- carbon2 %>%
  filter(species == "Acropora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(enrichment ~ treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term == "treatment") %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(p_adj_fdr)

results_acropora

```

Treatment affects glucose-6-phosphate in Acropora. It is depleted at 33°C.

```{r}
results_pocillopora <- carbon2 %>%
  filter(species == "Pocillopora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(enrichment ~ treatment*lifestage, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term %in% c("treatment", "lifestage", "treatment:lifestage")) %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(Compound)%>%
  filter(p_adj_fdr<0.05)

results_pocillopora

```

No effect of temperature in Pocillopora. a-ketoglutarate (less enriched in larvae), fructose-6-phosphate (less enriched in larvae), glucose (less enriched in larvae), glucoses-6-phosphate (less enriched in larvae), lactatae (less enriched in larvae), and pyruvate (less enriched in larvae) are affected by lifestage. 

Run test by group. 

```{r}
results <- carbon2 %>%
  mutate(group=paste0(species, "-", lifestage))%>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(enrichment ~ group*treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term %in% c("group", "treatment", "group:treatment")) %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(Compound)%>%
  filter(p_adj_fdr<0.05)

results

```

### Plot glucose only 

```{r}
plot_glucose2<-carbon2%>%
  filter(Compound=="Glucose")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/length(enrichment))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Glucose Enrichment")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_glucose2

ggsave(filename="figures/isotopes/glucose_enrichment.png", plot_glucose2, width=6, height=5)
```

### Plot pyruvate only 

```{r}
plot_pyruvate2<-carbon2%>%
  filter(Compound=="Pyruvate")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/length(enrichment))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Pyruvate Enrichment")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_pyruvate2

ggsave(filename="figures/isotopes/pyruvate_enrichment.png", plot_pyruvate2, width=6, height=5)
```

# Energy molecules: ADP, AMP, dAMP, NAD+, NADH, NADP+, NADPH concentration and labeling

## Pool size 

Subset to desired compounds 

```{r}
energy_list<-c("ADP", "AMP", "dAMP", "NAD+", "NADH", "NADP+", "NADPH")
```

```{r}
energy<-merged_metabolites%>%
  filter(Compound %in% energy_list)

head(energy)
```

Filter out controls and blanks for now. 
```{r}
energy<-energy%>%
  filter(!isotope=="12C")%>%
  filter(!lifestage=="Blank")%>%
  filter(!lifestage=="Ctrl")%>%
  filter(!treatment=="dark")
```

Plot

```{r}
plot3<-energy%>%
         
  ggplot(., aes(y=log.intensity.norm, x=treatment, color=lifestage)) + 
  facet_wrap(~Compound*species, scales="free")+
  geom_boxplot(position=position_dodge(0.8))+
  geom_point(position=position_dodge(0.8))+
  scale_fill_manual(values=c("gray", "purple"))+
  theme_classic()+
  xlab("Temperature")+
  ylab("log(Normalized Pool Size)")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot3
```

Run test using linear models. 

```{r}
results_acropora <- energy %>%
  filter(species == "Acropora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(log.intensity.norm ~ treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term == "treatment") %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(p_adj_fdr)

results_acropora

```

No effect of treatment on energy cofactors in Acropora.   

```{r}
results_pocillopora <- energy %>%
  filter(species == "Pocillopora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(log.intensity.norm ~ treatment*lifestage, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term %in% c("treatment", "lifestage", "treatment:lifestage")) %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(Compound)%>%
  filter(p_adj_fdr<0.05)

results_pocillopora

```

ADP (higehr in larvae), AMP (lower in larvae), NADP+ (higher in larvae), NADPH (lower in larvae), dAMP (lower in larvae) all affected by lifestage. NAD+ decreases with temp in recruits but not in larvae and is higher in larvae. 

## Enrichment

Subset to desired compounds 

```{r}
energy2<-merged_enrichment%>%
  filter(Compound %in% energy_list)

head(energy2)
```

Filter out controls and blanks for now. 
```{r}
energy2<-energy2%>%
  filter(!isotope=="12C")%>%
  filter(!lifestage=="Blank")%>%
  filter(!lifestage=="Ctrl")%>%
  filter(!treatment=="dark")
```

Plot

```{r}
plot4<-energy2%>%
         
  ggplot(., aes(y=enrichment, x=treatment, color=lifestage)) + 
  facet_wrap(~Compound*species, scales="free")+
  geom_boxplot(position=position_dodge(0.8))+
  geom_point(position=position_dodge(0.8))+
  scale_fill_manual(values=c("gray", "purple"))+
  theme_classic()+
  xlab("Temperature")+
  ylab("Enrichment")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot4
```

Run test using linear models. 

```{r}
results_acropora <- energy2 %>%
  filter(species == "Acropora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(enrichment ~ treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term == "treatment") %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(p_adj_fdr)

results_acropora

```

No effect of treatment on energy cofactor enrichment in Acropora.   

Missing data for larvae, not analyzed here.  

# Nitrogen metabolism: Glutamine and glutamate and dipeptide concentration and labeling 

## Pool size 

Subset to desired compounds 

```{r}
nitrogen_list<-c("Glutamine", "Glutamate", "Arginine-Glutamine")
```

```{r}
nitrogen<-merged_metabolites%>%
  filter(Compound %in% nitrogen_list)

head(nitrogen)
```

Filter out controls and blanks for now. 
```{r}
nitrogen<-nitrogen%>%
  filter(!isotope=="12C")%>%
  filter(!lifestage=="Blank")%>%
  filter(!lifestage=="Ctrl")%>%
  filter(!treatment=="dark")
```

Plot

```{r}
plot5<-nitrogen%>%
         
  ggplot(., aes(y=log.intensity.norm, x=treatment, color=lifestage)) + 
  facet_wrap(~Compound*species, scales="free")+
  geom_boxplot(position=position_dodge(0.8))+
  geom_point(position=position_dodge(0.8))+
  scale_fill_manual(values=c("gray", "purple"))+
  theme_classic()+
  xlab("Temperature")+
  ylab("log(Normalized Pool Size)")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot5
```

Run test using linear models. 

```{r}
results_acropora <- nitrogen %>%
  filter(species == "Acropora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(log.intensity.norm ~ treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term == "treatment") %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(p_adj_fdr)

results_acropora

```

Treatment affects arginine glutamine (higher at 33°C) only.   

```{r}
results_pocillopora <- nitrogen %>%
  filter(species == "Pocillopora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(log.intensity.norm ~ treatment*lifestage, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term %in% c("treatment", "lifestage", "treatment:lifestage")) %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(Compound)%>%
  filter(p_adj_fdr<0.05)

results_pocillopora

```

Glutamine modulated by temperature with higher concentrations in larvae and only recruits showing higher concentrations at 33°C. Arginine-glutamine (higher in larvae), glutamate (higher in larvae), and glutamine (higher in larvae) are affected by lifestage.  

Run test by group. 

```{r}
results <- nitrogen %>%
  mutate(group=paste0(species, "-", lifestage))%>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(log.intensity.norm ~ group*treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term %in% c("group", "treatment", "group:treatment")) %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(Compound)%>%
  filter(p_adj_fdr<0.05)

results

```

### Plot Glutamate only 

```{r}
plot_glutamate<-nitrogen%>%
  filter(Compound=="Glutamate")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(log.intensity.norm, na.rm=TRUE), se=sd(log.intensity.norm, na.rm=TRUE)/length(log.intensity.norm))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Glutamate Concentration")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_glutamate

ggsave(filename="figures/isotopes/glutamate_concentration.png", plot_glutamate, width=6, height=5)
```

### Plot glutamine only 


```{r}
plot_glutamine<-nitrogen%>%
  filter(Compound=="Glutamine")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(log.intensity.norm, na.rm=TRUE), se=sd(log.intensity.norm, na.rm=TRUE)/length(log.intensity.norm))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Glutamine Concentration")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_glutamine

ggsave(filename="figures/isotopes/glutamine_concentration.png", plot_glutamine, width=6, height=5)
```

### Plot arginine-glutamine only 

```{r}
plot_dipep<-nitrogen%>%
  filter(Compound=="Arginine-Glutamine")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(log.intensity.norm, na.rm=TRUE), se=sd(log.intensity.norm, na.rm=TRUE)/length(log.intensity.norm))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Arginine-Glutamine Concentration")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_dipep

ggsave(filename="figures/isotopes/arg-glu_concentration.png", plot_dipep, width=6, height=5)
```

## Enrichment

Subset to desired compounds 

```{r}
nitrogen2<-merged_enrichment%>%
  filter(Compound %in% nitrogen_list)

head(nitrogen2)
```

Filter out controls and blanks for now. 
```{r}
nitrogen2<-nitrogen2%>%
  filter(!isotope=="12C")%>%
  filter(!lifestage=="Blank")%>%
  filter(!lifestage=="Ctrl")%>%
  filter(!treatment=="dark")
```

Plot

```{r}
plot6<-nitrogen2%>%
         
  ggplot(., aes(y=enrichment, x=treatment, color=lifestage)) + 
  facet_wrap(~Compound*species, scales="free")+
  geom_boxplot(position=position_dodge(0.8))+
  geom_point(position=position_dodge(0.8))+
  scale_fill_manual(values=c("gray", "purple"))+
  theme_classic()+
  xlab("Temperature")+
  ylab("Enrichment")+
  theme(
    legend.position="right", 
    panel.border=element_rect(colour="black", fill=NA, linewidth=1),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"),
    text = element_text(size = 16, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black", angle=90, vjust = 1, hjust=1), 
    axis.title = element_text(face="bold")
    );plot6
```

Run test using linear models. 

```{r}
results_acropora <- nitrogen2 %>%
  filter(species == "Acropora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(enrichment ~ treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term == "treatment") %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(p_adj_fdr)

results_acropora

```

Treatment affects enrichment of arginine-glutamine (higher at 33C).  

```{r}
results_pocillopora <- nitrogen2 %>%
  filter(species == "Pocillopora") %>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(enrichment ~ treatment*lifestage, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term %in% c("treatment", "lifestage", "treatment:lifestage")) %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(Compound)%>%
  filter(p_adj_fdr<0.05)

results_pocillopora

```

Glutamate affected by treatment (lower at 33°C), and also modulated by lifestage (higer at 30°C in larvae and lower at 33°C in larvae). Glutamine is lower in larvae.   

Run test by group. 

```{r}
results <- nitrogen2 %>%
  mutate(group=paste0(species, "-", lifestage))%>%
  group_by(Compound) %>%
  
  do({
    fit <- aov(enrichment ~ group*treatment, data = .)
    tidy(fit)
  }) %>%
  
  ungroup() %>%
  
  # keep only the treatment effect row
  filter(term %in% c("group", "treatment", "group:treatment")) %>%
  mutate(p_adj_fdr = p.adjust(p.value, method = "fdr")) %>%
  arrange(Compound)%>%
  filter(p_adj_fdr<0.05)

results

```

### Plot Glutamate only 

```{r}
plot_glutamate2<-nitrogen2%>%
  filter(Compound=="Glutamate")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/length(enrichment))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Glutamate Enrichment")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_glutamate2

ggsave(filename="figures/isotopes/glutamate_enrichment.png", plot_glutamate2, width=6, height=5)
```

### Plot glutamine only 

```{r}
plot_glutamine2<-nitrogen2%>%
  filter(Compound=="Glutamine")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/length(enrichment))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Glutamine Enrichment")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_glutamine2

ggsave(filename="figures/isotopes/glutamine_enrichment.png", plot_glutamine2, width=6, height=5)
```

### Plot arginine-glutamine only 

```{r}
plot_dipep2<-nitrogen2%>%
  filter(Compound=="Arginine-Glutamine")%>%
  group_by(species, treatment, lifestage)%>%
  summarise(mean=mean(enrichment, na.rm=TRUE), se=sd(enrichment, na.rm=TRUE)/length(enrichment))%>%
         
  ggplot(., aes(y=mean, x=treatment, color=species, linetype=lifestage)) + 
  geom_point(position=position_dodge(0.2), size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), position=position_dodge(0.2), width=0)+
  geom_line(aes(group=interaction(lifestage, species)), position=position_dodge(0.2))+
  theme_classic()+
  scale_color_manual(values=c("orange", "purple3"), name="")+
  scale_linetype_manual(values=c("dashed", "solid"), name="")+
  xlab("Temperature (°C)")+
  ylab("Arginine-Glutamine Enrichment")+
  theme(
    legend.position="right", 
    text = element_text(size = 14, color="black"), 
    axis.text.y = element_text(size=14, color="black"), 
    axis.text.x = element_text(size=12, color="black"), 
    axis.title = element_text(face="bold")
    );plot_dipep2

ggsave(filename="figures/isotopes/arg-glu_enrichment.png", plot_dipep2, width=6, height=5)
```

Try a ridge plot. 
```{r}
library(ggridges)

ridge_dipep <- nitrogen2 %>%
  filter(Compound == "Arginine-Glutamine") %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33")),
    species   = factor(species),
    lifestage = factor(lifestage)
  )

plot_dipep_ridge <- ggplot(
  ridge_dipep,
  aes(
    x    = enrichment,
    y    = treatment,
    fill = species,
    color = species
  )
) +
  geom_density_ridges(
    alpha = 0.6,
    scale = 1.2,
    size = 0.6
  ) +
  facet_wrap(~ lifestage, ncol = 1, scales = "free_y") +
  scale_fill_manual(values = c("orange", "purple3")) +
  scale_color_manual(values = c("orange", "purple3")) +
  labs(
    x = "Arginine–Glutamine Enrichment",
    y = "Temperature (°C)",
    fill = "Species",
    color = "Species"
  ) +
  theme_classic() +
  theme(
    strip.text = element_text(size = 14, face = "bold"),
    text       = element_text(size = 14, color = "black"),
    axis.text  = element_text(size = 12, color = "black"),
    legend.position = "right"
  )

plot_dipep_ridge

```

Show all nitrogen metabolites in one ridge plot. 

```{r}
ridge_three <- nitrogen2 %>%
  filter(Compound %in% c("Glutamine", "Glutamate", "Arginine-Glutamine")) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33")),
    Compound  = factor(Compound,
                       levels = c("Glutamine", "Glutamate", "Arginine-Glutamine")),
    species   = factor(species),
    lifestage = factor(lifestage)
  )

plot_ridge_three <- ggplot(
  ridge_three,
  aes(
    x     = enrichment,
    y     = treatment,
    fill  = species,
    color = species
  )
) +
  geom_density_ridges(
    alpha = 0.6,
    scale = 1.1,
    size  = 0.5
  ) +
  facet_grid(Compound ~ lifestage, scales = "free_y") +
  scale_fill_manual(values = c("orange", "purple3"), name = "Species") +
  scale_color_manual(values = c("orange", "purple3"), guide = "none") +
  labs(
    x = "13C enrichment",
    y = "Temperature (°C)"
  ) +
  theme_classic() +
  theme(
    strip.text   = element_text(size = 12, face = "bold"),
    text         = element_text(size = 14, color = "black"),
    axis.text    = element_text(size = 11, color = "black"),
    legend.position = "right"
  )

plot_ridge_three

```

Try a lollipop plot. 
```{r}
dipep_summary <- nitrogen2 %>%
  filter(Compound == "Arginine-Glutamine") %>%
  group_by(species, lifestage, treatment) %>%
  summarise(mean_enrich = mean(enrichment, na.rm = TRUE),
            se = sd(enrichment, na.rm = TRUE) / sqrt(n()),
            .groups = "drop") %>%
  group_by(species, lifestage) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33")),
    ref27     = mean_enrich[treatment == "27"],
    delta     = mean_enrich - ref27
  ) %>%
  ungroup()%>%
  filter(!treatment=="27")

gg_lollipop <- ggplot(
  dipep_summary,
  aes(x = treatment, y = delta, color = species)
) +
  # baseline
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.4) +

  # vertical lollipop sticks (NO dodge)
  geom_segment(aes(xend = treatment, y = 0, yend = delta),
               linewidth = 1.1) +

  # lollipop heads
  geom_point(aes(shape = species),
             size = 4.5,
             stroke = 1.2,
             fill = "white") +

  # error bars
  #geom_errorbar(aes(ymin = delta - se,
  #                  ymax = delta + se),
  #              width = 0.06,
  #              linewidth = 0.8) +

  facet_wrap(~ lifestage) +
  theme_classic() +
  scale_color_manual(values = c("orange", "purple3"), name = "Species") +
  scale_shape_manual(values = c(21, 24), name = "Species") +
  labs(
    x = "Temperature (°C)",
    y = "Δ Enrichment relative to 27°C"
  ) +
  theme(
    text        = element_text(size = 14, color = "black"),
    axis.text   = element_text(size = 12, color = "black"),
    axis.title  = element_text(face = "bold"),
    strip.text  = element_text(size = 13, face = "bold"),
    legend.position = "right"
  )

gg_lollipop

```

# Strategy plots for specific targets 

Make a master data frame 

```{r}
merged_metabolites<-merged_metabolites%>%
  select(!polarity)%>%
  select(!intensity.norm)

all_data<-left_join(merged_metabolites, merged_enrichment)
head(all_data)

all_data<-all_data%>%
  filter(!lifestage=="Blank")%>%
  filter(!lifestage=="Ctrl")%>%
  filter(!isotope=="12C")%>%
  filter(!treatment=="dark")

head(all_data)
```

Plot enrichment and concentration in one plot. 

Glucose
```{r}
library(ggrepel)   # for nice labels (install.packages("ggrepel") if needed)

# 1. Summarise glucose concentration & enrichment
glucose_sum <- all_data %>%
  filter(Compound == "Glucose") %>%
  group_by(species, lifestage, treatment) %>%
  summarise(
    mean_conc   = mean(log.intensity.norm, na.rm = TRUE),
    se_conc     = sd(log.intensity.norm, na.rm = TRUE) / sqrt(n()),
    mean_enrich = mean(enrichment, na.rm = TRUE),
    se_enrich   = sd(enrichment, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33"))
  )

# 2. “Strategy space” lollipop-scatter for glucose
plot_glucose_strategy <- ggplot(
  glucose_sum,
  aes(x = mean_conc,
      y = mean_enrich,
      color = species,
      shape = lifestage)
) +
  # error bars in both directions (optional)
  geom_errorbarh(aes(xmin = mean_conc - se_conc,
                     xmax = mean_conc + se_conc),
                 height = 0,
                 linewidth = 0.6,
                 alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_enrich - se_enrich,
                    ymax = mean_enrich + se_enrich),
                width = 0,
                linewidth = 0.6,
                alpha = 0.7) +
  
  # arrows connecting temperatures for each species × lifestage
  geom_path(aes(group = interaction(species, lifestage)),
            linewidth = 0.7,
            arrow = arrow(type = "closed",
                          length = unit(0.15, "cm")),
            alpha = 0.7) +
  
  # points
  geom_point(size = 4, stroke = 1.2, fill = "white") +
  
  # label points with temperature
  geom_text_repel(aes(label = treatment),
                  size = 4,
                  show.legend = FALSE,
                  max.overlaps = Inf) +
  
  #facet_wrap(~ lifestage) +
  scale_color_manual(values = c("orange", "purple3"), name = "Species") +
  scale_shape_manual(values = c(21, 24), name = "Lifestage") +
  labs(
    x = "Glucose concentration",
    y = "Glucose 13C enrichment"
  ) +
  theme_classic() +
  theme(
    strip.text   = element_text(size = 13, face = "bold"),
    text         = element_text(size = 14, color = "black"),
    axis.text    = element_text(size = 12, color = "black"),
    axis.title   = element_text(face = "bold"),
    legend.position = "right"
  ); plot_glucose_strategy

ggsave(filename="figures/isotopes/glucose-strategy.png", plot_glucose_strategy, width=6, height=5)
```

Pyruvate
```{r}
# 1. Summarise glucose concentration & enrichment
pyruvate_sum <- all_data %>%
  filter(Compound == "Pyruvate") %>%
  group_by(species, lifestage, treatment) %>%
  summarise(
    mean_conc   = mean(log.intensity.norm, na.rm = TRUE),
    se_conc     = sd(log.intensity.norm, na.rm = TRUE) / sqrt(n()),
    mean_enrich = mean(enrichment, na.rm = TRUE),
    se_enrich   = sd(enrichment, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33"))
  )

# 2. “Strategy space” lollipop-scatter for glucose
plot_pyruvate_strategy <- ggplot(
  pyruvate_sum,
  aes(x = mean_conc,
      y = mean_enrich,
      color = species,
      shape = lifestage)
) +
  # error bars in both directions (optional)
  geom_errorbarh(aes(xmin = mean_conc - se_conc,
                     xmax = mean_conc + se_conc),
                 height = 0,
                 linewidth = 0.6,
                 alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_enrich - se_enrich,
                    ymax = mean_enrich + se_enrich),
                width = 0,
                linewidth = 0.6,
                alpha = 0.7) +
  
  # arrows connecting temperatures for each species × lifestage
  geom_path(aes(group = interaction(species, lifestage)),
            linewidth = 0.7,
            arrow = arrow(type = "closed",
                          length = unit(0.15, "cm")),
            alpha = 0.7) +
  
  # points
  geom_point(size = 4, stroke = 1.2, fill = "white") +
  
  # label points with temperature
  geom_text_repel(aes(label = treatment),
                  size = 4,
                  show.legend = FALSE,
                  max.overlaps = Inf) +
  
  #facet_wrap(~ lifestage) +
  scale_color_manual(values = c("orange", "purple3"), name = "Species") +
  scale_shape_manual(values = c(21, 24), name = "Lifestage") +
  labs(
    x = "Pyruvate concentration",
    y = "Pyruvate 13C enrichment"
  ) +
  theme_classic() +
  theme(
    strip.text   = element_text(size = 13, face = "bold"),
    text         = element_text(size = 14, color = "black"),
    axis.text    = element_text(size = 12, color = "black"),
    axis.title   = element_text(face = "bold"),
    legend.position = "right"
  ); plot_pyruvate_strategy

ggsave(filename="figures/isotopes/pyruvate-strategy.png", plot_pyruvate_strategy, width=6, height=5)
```

Glutamate
```{r}
# 1. Summarise glucose concentration & enrichment
glutamate_sum <- all_data %>%
  filter(Compound == "Glutamate") %>%
  group_by(species, lifestage, treatment) %>%
  summarise(
    mean_conc   = mean(log.intensity.norm, na.rm = TRUE),
    se_conc     = sd(log.intensity.norm, na.rm = TRUE) / sqrt(n()),
    mean_enrich = mean(enrichment, na.rm = TRUE),
    se_enrich   = sd(enrichment, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33"))
  )

# 2. “Strategy space” lollipop-scatter for glucose
plot_glutamate_strategy <- ggplot(
  glutamate_sum,
  aes(x = mean_conc,
      y = mean_enrich,
      color = species,
      shape = lifestage)
) +
  # error bars in both directions (optional)
  geom_errorbarh(aes(xmin = mean_conc - se_conc,
                     xmax = mean_conc + se_conc),
                 height = 0,
                 linewidth = 0.6,
                 alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_enrich - se_enrich,
                    ymax = mean_enrich + se_enrich),
                width = 0,
                linewidth = 0.6,
                alpha = 0.7) +
  
  # arrows connecting temperatures for each species × lifestage
  geom_path(aes(group = interaction(species, lifestage)),
            linewidth = 0.7,
            arrow = arrow(type = "closed",
                          length = unit(0.15, "cm")),
            alpha = 0.7) +
  
  # points
  geom_point(size = 4, stroke = 1.2, fill = "white") +
  
  # label points with temperature
  geom_text_repel(aes(label = treatment),
                  size = 4,
                  show.legend = FALSE,
                  max.overlaps = Inf) +
  
  #facet_wrap(~ lifestage) +
  scale_color_manual(values = c("orange", "purple3"), name = "Species") +
  scale_shape_manual(values = c(21, 24), name = "Lifestage") +
  labs(
    x = "Glutamate concentration",
    y = "Glutamate 13C enrichment"
  ) +
  theme_classic() +
  theme(
    strip.text   = element_text(size = 13, face = "bold"),
    text         = element_text(size = 14, color = "black"),
    axis.text    = element_text(size = 12, color = "black"),
    axis.title   = element_text(face = "bold"),
    legend.position = "right"
  ); plot_glutamate_strategy

ggsave(filename="figures/isotopes/glutamate-strategy.png", plot_glutamate_strategy, width=6, height=5)
```

Glutamine
```{r}
# 1. Summarise glucose concentration & enrichment
glutamine_sum <- all_data %>%
  filter(Compound == "Glutamine") %>%
  group_by(species, lifestage, treatment) %>%
  summarise(
    mean_conc   = mean(log.intensity.norm, na.rm = TRUE),
    se_conc     = sd(log.intensity.norm, na.rm = TRUE) / sqrt(n()),
    mean_enrich = mean(enrichment, na.rm = TRUE),
    se_enrich   = sd(enrichment, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33"))
  )

# 2. “Strategy space” lollipop-scatter for glucose
plot_glutamine_strategy <- ggplot(
  glutamine_sum,
  aes(x = mean_conc,
      y = mean_enrich,
      color = species,
      shape = lifestage)
) +
  # error bars in both directions (optional)
  geom_errorbarh(aes(xmin = mean_conc - se_conc,
                     xmax = mean_conc + se_conc),
                 height = 0,
                 linewidth = 0.6,
                 alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_enrich - se_enrich,
                    ymax = mean_enrich + se_enrich),
                width = 0,
                linewidth = 0.6,
                alpha = 0.7) +
  
  # arrows connecting temperatures for each species × lifestage
  geom_path(aes(group = interaction(species, lifestage)),
            linewidth = 0.7,
            arrow = arrow(type = "closed",
                          length = unit(0.15, "cm")),
            alpha = 0.7) +
  
  # points
  geom_point(size = 4, stroke = 1.2, fill = "white") +
  
  # label points with temperature
  geom_text_repel(aes(label = treatment),
                  size = 4,
                  show.legend = FALSE,
                  max.overlaps = Inf) +
  
  #facet_wrap(~ lifestage) +
  scale_color_manual(values = c("orange", "purple3"), name = "Species") +
  scale_shape_manual(values = c(21, 24), name = "Lifestage") +
  labs(
    x = "Glutamine concentration",
    y = "Glutamine 13C enrichment"
  ) +
  theme_classic() +
  theme(
    strip.text   = element_text(size = 13, face = "bold"),
    text         = element_text(size = 14, color = "black"),
    axis.text    = element_text(size = 12, color = "black"),
    axis.title   = element_text(face = "bold"),
    legend.position = "right"
  ); plot_glutamine_strategy

ggsave(filename="figures/isotopes/glutamine-strategy.png", plot_glutamine_strategy, width=6, height=5)
```

Arginine-Glutamine
```{r}
# 1. Summarise glucose concentration & enrichment
dipep_sum <- all_data %>%
  filter(Compound == "Arginine-Glutamine") %>%
  group_by(species, lifestage, treatment) %>%
  summarise(
    mean_conc   = mean(log.intensity.norm, na.rm = TRUE),
    se_conc     = sd(log.intensity.norm, na.rm = TRUE) / sqrt(n()),
    mean_enrich = mean(enrichment, na.rm = TRUE),
    se_enrich   = sd(enrichment, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33"))
  )

# 2. “Strategy space” lollipop-scatter for glucose
plot_dipep_strategy <- ggplot(
  dipep_sum,
  aes(x = mean_conc,
      y = mean_enrich,
      color = species,
      shape = lifestage)
) +
  # error bars in both directions (optional)
  geom_errorbarh(aes(xmin = mean_conc - se_conc,
                     xmax = mean_conc + se_conc),
                 height = 0,
                 linewidth = 0.6,
                 alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_enrich - se_enrich,
                    ymax = mean_enrich + se_enrich),
                width = 0,
                linewidth = 0.6,
                alpha = 0.7) +
  
  # arrows connecting temperatures for each species × lifestage
  geom_path(aes(group = interaction(species, lifestage)),
            linewidth = 0.7,
            arrow = arrow(type = "closed",
                          length = unit(0.15, "cm")),
            alpha = 0.7) +
  
  # points
  geom_point(size = 4, stroke = 1.2, fill = "white") +
  
  # label points with temperature
  geom_text_repel(aes(label = treatment),
                  size = 4,
                  show.legend = FALSE,
                  max.overlaps = Inf) +
  
  #facet_wrap(~ lifestage) +
  scale_color_manual(values = c("orange", "purple3"), name = "Species") +
  scale_shape_manual(values = c(21, 24), name = "Lifestage") +
  labs(
    x = "Arginine-Glutamine concentration",
    y = "Arginine-Glutamine 13C enrichment"
  ) +
  theme_classic() +
  theme(
    strip.text   = element_text(size = 13, face = "bold"),
    text         = element_text(size = 14, color = "black"),
    axis.text    = element_text(size = 12, color = "black"),
    axis.title   = element_text(face = "bold"),
    legend.position = "right"
  ); plot_dipep_strategy

ggsave(filename="figures/isotopes/dipep-strategy.png", plot_dipep_strategy, width=6, height=5)
```

Lactate
```{r}
# 1. Summarise glucose concentration & enrichment
lactate_sum <- all_data %>%
  filter(Compound == "Lactate") %>%
  group_by(species, lifestage, treatment) %>%
  summarise(
    mean_conc   = mean(log.intensity.norm, na.rm = TRUE),
    se_conc     = sd(log.intensity.norm, na.rm = TRUE) / sqrt(n()),
    mean_enrich = mean(enrichment, na.rm = TRUE),
    se_enrich   = sd(enrichment, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33"))
  )

# 2. “Strategy space” lollipop-scatter for glucose
plot_lactate_strategy <- ggplot(
  lactate_sum,
  aes(x = mean_conc,
      y = mean_enrich,
      color = species,
      shape = lifestage)
) +
  # error bars in both directions (optional)
  geom_errorbarh(aes(xmin = mean_conc - se_conc,
                     xmax = mean_conc + se_conc),
                 height = 0,
                 linewidth = 0.6,
                 alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_enrich - se_enrich,
                    ymax = mean_enrich + se_enrich),
                width = 0,
                linewidth = 0.6,
                alpha = 0.7) +
  
  # arrows connecting temperatures for each species × lifestage
  geom_path(aes(group = interaction(species, lifestage)),
            linewidth = 0.7,
            arrow = arrow(type = "closed",
                          length = unit(0.15, "cm")),
            alpha = 0.7) +
  
  # points
  geom_point(size = 4, stroke = 1.2, fill = "white") +
  
  # label points with temperature
  geom_text_repel(aes(label = treatment),
                  size = 4,
                  show.legend = FALSE,
                  max.overlaps = Inf) +
  
  #facet_wrap(~ lifestage) +
  scale_color_manual(values = c("orange", "purple3"), name = "Species") +
  scale_shape_manual(values = c(21, 24), name = "Lifestage") +
  labs(
    x = "Lactate concentration",
    y = "Lactate 13C enrichment"
  ) +
  theme_classic() +
  theme(
    strip.text   = element_text(size = 13, face = "bold"),
    text         = element_text(size = 14, color = "black"),
    axis.text    = element_text(size = 12, color = "black"),
    axis.title   = element_text(face = "bold"),
    legend.position = "right"
  ); plot_lactate_strategy

ggsave(filename="figures/isotopes/lactate-strategy.png", plot_lactate_strategy, width=6, height=5)
```

# Strategy plots for all metabolites 

```{r}
all_data$group<-paste(all_data$species, all_data$lifestage)
```

Output a table of full permanova results. 

```{r}
permanova_results <- vector("list", length(compounds))
names(permanova_results) <- compounds

for (cmp in compounds) {

  df_cmp <- all_data %>%
    filter(Compound == cmp) %>%
    mutate(
      treatment = as.character(treatment),
      treatment = if (all(treat_levels %in% treatment))
        factor(treatment, levels = treat_levels) else factor(treatment),
      group = interaction(species, lifestage, drop = TRUE)
    ) %>%
    select(log.intensity.norm, enrichment, group, treatment) %>%
    drop_na()

  # defaults
  n_obs <- nrow(df_cmp)

  p_group <- p_temp <- p_int <- NA_real_
  r2_group <- r2_temp <- r2_int <- NA_real_
  f_group <- f_temp <- f_int <- NA_real_
  df_group <- df_temp <- df_int <- NA_real_

  ran <- FALSE
  note <- NA_character_

  if (n_obs >= 6 &&
      nlevels(df_cmp$group) >= 2 &&
      nlevels(df_cmp$treatment) >= 2 &&
      sd(df_cmp$log.intensity.norm) > 0 &&
      sd(df_cmp$enrichment) > 0) {

    X <- scale(as.matrix(df_cmp[, c("log.intensity.norm", "enrichment")]))
    if (!anyNA(X)) {

      dist_mat <- dist(X, method = "euclidean")

      # -----------------------
      # 1) Additive model: main effects
      # -----------------------
      perm_add <- adonis2(
        dist_mat ~ group + treatment,
        data = df_cmp,
        permutations = 999,
        by = "margin"
      )

      if ("group" %in% rownames(perm_add)) {
        p_group  <- perm_add["group", "Pr(>F)"]
        r2_group <- perm_add["group", "R2"]
        f_group  <- perm_add["group", "F"]
        df_group <- perm_add["group", "Df"]
      }

      if ("treatment" %in% rownames(perm_add)) {
        p_temp  <- perm_add["treatment", "Pr(>F)"]
        r2_temp <- perm_add["treatment", "R2"]
        f_temp  <- perm_add["treatment", "F"]
        df_temp <- perm_add["treatment", "Df"]
      }

      # -----------------------
      # 2) Full model: interaction
      # -----------------------
      perm_full <- adonis2(
        dist_mat ~ group * treatment,
        data = df_cmp,
        permutations = 999,
        by = "terms"
      )

      if ("group:treatment" %in% rownames(perm_full)) {
        p_int  <- perm_full["group:treatment", "Pr(>F)"]
        r2_int <- perm_full["group:treatment", "R2"]
        f_int  <- perm_full["group:treatment", "F"]
        df_int <- perm_full["group:treatment", "Df"]
      }

      ran <- TRUE

    } else {
      note <- "NA after scaling (zero variance)"
    }

  } else {
    note <- "Insufficient data or variance"
  }

  permanova_results[[cmp]] <- tibble(
    Compound = cmp,
    n_observations = n_obs,

    df_group = df_group,
    F_group  = f_group,
    R2_group = r2_group,
    p_group  = p_group,

    df_temperature = df_temp,
    F_temperature  = f_temp,
    R2_temperature = r2_temp,
    p_temperature  = p_temp,

    df_group_temp  = df_int,
    F_group_temp   = f_int,
    R2_group_temp  = r2_int,
    p_group_temp   = p_int,

    ran_permanova = ran,
    note = note
  )
}

permanova_table <- bind_rows(permanova_results)

# Optional: FDR correction per term
permanova_table <- permanova_table %>%
  mutate(
    p_group_FDR        = p.adjust(p_group, method = "fdr"),
    p_temperature_FDR  = p.adjust(p_temperature, method = "fdr"),
    p_group_temp_FDR   = p.adjust(p_group_temp, method = "fdr")
  )

permanova_table

write_csv(permanova_table, "output/isotopes/permanova_strategies.csv")

# create a lookup table for plotting
perm_lookup <- permanova_table %>%
  mutate(
    Compound = trimws(as.character(Compound)),   # ensures matching
    ran_permanova = as.logical(ran_permanova)    # ensures TRUE/FALSE not "TRUE"/1
  ) %>%
  distinct(Compound, .keep_all = TRUE)
```

Loop through for all metabolites and run a PERMANOVA test on the 2D strategy space (concentration x enrichment).  
```{r}
library(grid)
library(vegan)
library(ggtext)

out_dir <- "figures/isotopes/strategy_plots"
dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

compounds <- sort(unique(all_data$Compound))
treat_levels <- c("27","30","33")

safe_name <- function(x) {
  x %>%
    str_trim() %>%
    str_replace_all("[/\\\\]", "_") %>%
    str_replace_all("[^A-Za-z0-9._-]+", "_")
}

fmt_p <- function(p) {
  if (is.na(p)) "NA"
  else if (p < 0.001) "<0.001"
  else sprintf("%.3f", p)
}

fmt_r2 <- function(r2) {
  if (is.na(r2)) "NA"
  else sprintf("%.3f", r2)
}

for (cmp in compounds) {

  # ===========================
  # A) PERMANOVA (replicate-level)
  # ===========================
  df_cmp <- all_data %>%
    filter(Compound == cmp) %>%
    mutate(
      treatment = as.character(treatment),
      treatment = if (all(treat_levels %in% treatment)) factor(treatment, levels = treat_levels) else factor(treatment),
      group     = interaction(species, lifestage, drop = TRUE)
    ) %>%
    select(log.intensity.norm, enrichment, group, treatment) %>%
    tidyr::drop_na()

# pull results for this metabolite
perm_vals <- perm_lookup %>% filter(Compound == cmp)

# Safe getters (avoid "length zero")
get1 <- function(x) if (length(x) == 0) NA_real_ else x[1]
get1_chr <- function(x) if (length(x) == 0) NA_character_ else x[1]

ran_flag <- get1(perm_vals$ran_permanova)
note_txt <- get1_chr(perm_vals$note)

bold_if_sig <- function(line, p) {
  if (!is.na(p) && p < 0.05) paste0("<b>", line, "</b>") else line
}

perm_vals <- perm_lookup %>% filter(Compound == trimws(as.character(cmp)))

if (nrow(perm_vals) == 0) {
  perm_label <- "PERMANOVA not run<br/>(no lookup match)"
} else if (isFALSE(perm_vals$ran_permanova[1])) {
  perm_label <- paste0("PERMANOVA not run<br/>", perm_vals$note[1])
} else {

  l1 <- paste0("group: pFDR=", fmt_p(perm_vals$p_group_FDR[1]),
               "  R²=", fmt_r2(perm_vals$R2_group[1]))
  l2 <- paste0("temp : pFDR=", fmt_p(perm_vals$p_temperature_FDR[1]),
               "  R²=", fmt_r2(perm_vals$R2_temperature[1]))
  l3 <- paste0("g×t  : pFDR=", fmt_p(perm_vals$p_group_temp_FDR[1]),
               "  R²=", fmt_r2(perm_vals$R2_group_temp[1]))

  perm_label <- paste0(
    "PERMANOVA (scaled Euclid)<br/>",
    bold_if_sig(l1, perm_vals$p_group_FDR[1]), "<br/>",
    bold_if_sig(l2, perm_vals$p_temperature_FDR[1]), "<br/>",
    bold_if_sig(l3, perm_vals$p_group_temp_FDR[1])
  )
}


  # ===========================
  # B) Summary for plotting (means + SE)
  # ===========================
  cmp_sum <- all_data %>%
    filter(Compound == cmp) %>%
    group_by(species, lifestage, treatment) %>%
    summarise(
      mean_conc   = mean(log.intensity.norm, na.rm = TRUE),
      se_conc     = sd(log.intensity.norm, na.rm = TRUE) / sqrt(sum(!is.na(log.intensity.norm))),
      mean_enrich = mean(enrichment, na.rm = TRUE),
      se_enrich   = sd(enrichment, na.rm = TRUE) / sqrt(sum(!is.na(enrichment))),
      .groups = "drop"
    ) %>%
    mutate(
      treatment = as.character(treatment),
      treatment = if (all(treat_levels %in% treatment)) factor(treatment, levels = treat_levels) else factor(treatment)
    )

  if (nrow(cmp_sum) == 0) next

  # ===========================
  # C) Plot (annotation outside panel)
  # ===========================
  p <- ggplot(
    cmp_sum,
    aes(x = mean_conc, y = mean_enrich, color = species, shape = lifestage)
  ) +
    geom_errorbarh(aes(xmin = mean_conc - se_conc, xmax = mean_conc + se_conc),
                   height = 0, linewidth = 0.6, alpha = 0.7) +
    geom_errorbar(aes(ymin = mean_enrich - se_enrich, ymax = mean_enrich + se_enrich),
                  width = 0, linewidth = 0.6, alpha = 0.7) +
    geom_path(aes(group = interaction(species, lifestage)),
              linewidth = 0.7,
              arrow = arrow(type = "closed", length = unit(0.15, "cm")),
              alpha = 0.7) +
    geom_point(size = 4, stroke = 1.2, fill = "white") +
    geom_text_repel(aes(label = treatment),
                    size = 4, show.legend = FALSE, max.overlaps = Inf) +
    scale_color_manual(values = c("orange", "purple3"), name = "Species") +
    scale_shape_manual(values = c(21, 24), name = "Lifestage") +
    labs(
      x = paste0(cmp, " concentration"),
      y = paste0(cmp, " 13C enrichment")
    ) +
    # Put label OUTSIDE the panel on the right
ggtext::geom_richtext(
  data = data.frame(x = Inf, y = Inf, lab = perm_label),
  aes(x = x, y = y, label = lab),
  hjust = -0.05, vjust = 1.05,
  size = 3.6,
  label.size = 0.25,
  fill = "white",
  inherit.aes = FALSE
)+
    coord_cartesian(clip = "off") +
    theme_classic() +
    theme(
      text = element_text(size = 14, color = "black"),
      axis.text = element_text(size = 12, color = "black"),
      axis.title = element_text(face = "bold"),
      legend.position = "right",
      plot.margin = margin(t = 10, r = 120, b = 10, l = 10)  # extra right margin for the label
    )

  # ===========================
  # D) Save
  # ===========================
  file_base <- paste0(safe_name(cmp), "-strategy")
  ggsave(
    filename = file.path(out_dir, paste0(file_base, ".png")),
    plot = p,
    width = 7.5,   # slightly wider to accommodate outside annotation
    height = 5,
    dpi = 300
  )
}

```


# Strategy plot for glycolysis pathway 

```{r}
glycolysis_mets <- c(
  "Glucose",
  "Glucose-6-phosphate",
  "Fructose-6-phosphate",
  "Pyruvate"
)
```

```{r}
glyco_centroid <- all_data %>%
  filter(Compound %in% glycolysis_mets) %>%
  group_by(sample, species, lifestage, treatment) %>%
  summarise(
    pathway_conc   = mean(log.intensity.norm, na.rm = TRUE),
    pathway_enrich = mean(enrichment, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
glyco_mat <- all_data %>%
  filter(Compound %in% glycolysis_mets) %>%
  select(sample, species, lifestage, treatment,
         Compound, log.intensity.norm, enrichment) %>%
  pivot_longer(
    cols = c(log.intensity.norm, enrichment),
    names_to = "metric",
    values_to = "value"
  ) %>%
  unite(var, Compound, metric) %>%
  pivot_wider(
    names_from = var,
    values_from = value
  ) %>%
  drop_na()
```

```{r}
X <- glyco_mat %>%
  select(-sample, -species, -lifestage, -treatment) %>%
  scale()

glyco_pca <- prcomp(X, center = TRUE, scale. = TRUE)
```

```{r}
pca_df <- as.data.frame(glyco_pca$x) %>%
  bind_cols(glyco_mat %>% select(species, lifestage, treatment))

ggplot(pca_df,
       aes(PC1, PC2,
           color = species,
           shape = lifestage,
           group = interaction(species, lifestage))) +
  geom_path(aes(group = interaction(species, lifestage)),
            arrow = arrow(length = unit(0.15, "cm")),
            alpha = 0.6) +
  scale_color_manual(values=c("orange", "purple"))+
  geom_point(size = 3) +
  facet_wrap(~ treatment) +
  theme_classic()
```

Try centroid method. 
```{r}
glyco_group_centroid <- glyco_centroid %>%
  group_by(species, lifestage, treatment) %>%
  summarise(
    mean_conc   = mean(pathway_conc, na.rm = TRUE),
    mean_enrich = mean(pathway_enrich, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33"))
  )
```

```{r}
ggplot() +

  # --------------------
  # Replicate-level points (transparent)
  # --------------------
  geom_point(
    data = glyco_centroid,
    aes(
      pathway_conc,
      pathway_enrich,
      color = species,
      shape = lifestage
    ),
    size = 3,
    alpha = 0.35
  ) +

  # --------------------
  # Centroid trajectories (colored arrows)
  # --------------------
  geom_path(
    data = glyco_group_centroid,
    aes(
      mean_conc,
      mean_enrich,
      group = interaction(species, lifestage),
      color = species      # <<< match species color
    ),
    linewidth = 1.2,
    alpha = 1,
    arrow = arrow(
      type = "closed",
      length = unit(0.2, "cm")
    )
  ) +

  # --------------------
  # Centroid points (same color & shape as group)
  # --------------------
  geom_point(
    data = glyco_group_centroid,
    aes(
      mean_conc,
      mean_enrich,
      color = species,
      shape = lifestage
    ),
    size = 4.5,
    stroke = 1.2,
    fill = "white"   # works for shapes 21/24
  ) +

  # --------------------
  # Temperature labels at centroids
  # --------------------
  geom_text_repel(
    data = glyco_group_centroid,
    aes(
      mean_conc,
      mean_enrich,
      label = treatment,
      color = species
    ),
    size = 4,
    show.legend = FALSE
  ) +

  scale_color_manual(values = c("orange", "purple")) +
  scale_shape_manual(values = c(21, 24)) +

  theme_classic() +
  labs(
    x = "Glycolysis pathway concentration",
    y = "Glycolysis pathway 13C enrichment", 
    title = "Glycolysis Pathway"
  )
```




# Strategy plot for GS-GOGAT pathway 

```{r}
gogat_mets <- c(
  "Glutamine",
  "Glutamate",
  "a-ketoglutarate",
  "Arginine-Glutamine", 
  "Arginine"
)
```

```{r}
gogat_centroid <- all_data %>%
  filter(Compound %in% gogat_mets) %>%
  droplevels() %>%
  group_by(sample, species, lifestage, treatment) %>%
  summarise(
    pathway_conc   = mean(log.intensity.norm, na.rm = TRUE),
    pathway_enrich = mean(enrichment, na.rm = TRUE),
    .groups = "drop"
  )

levels(gogat_centroid$Compound)
```


Try centroid method. 
```{r}
gogat_group_centroid <- gogat_centroid %>%
  group_by(species, lifestage, treatment) %>%
  summarise(
    mean_conc   = mean(pathway_conc, na.rm = TRUE),
    mean_enrich = mean(pathway_enrich, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    treatment = factor(treatment, levels = c("27", "30", "33"))
  )
```

```{r}
ggplot() +

  # --------------------
  # Replicate-level points (transparent)
  # --------------------
  geom_point(
    data = gogat_centroid,
    aes(
      pathway_conc,
      pathway_enrich,
      color = species,
      shape = lifestage
    ),
    size = 3,
    alpha = 0.35
  ) +

  # --------------------
  # Centroid trajectories (colored arrows)
  # --------------------
  geom_path(
    data = gogat_group_centroid,
    aes(
      mean_conc,
      mean_enrich,
      group = interaction(species, lifestage),
      color = species      # <<< match species color
    ),
    linewidth = 1.2,
    alpha = 1,
    arrow = arrow(
      type = "closed",
      length = unit(0.2, "cm")
    )
  ) +

  # --------------------
  # Centroid points (same color & shape as group)
  # --------------------
  geom_point(
    data = gogat_group_centroid,
    aes(
      mean_conc,
      mean_enrich,
      color = species,
      shape = lifestage
    ),
    size = 4.5,
    stroke = 1.2,
    fill = "white"   # works for shapes 21/24
  ) +

  # --------------------
  # Temperature labels at centroids
  # --------------------
  geom_text_repel(
    data = gogat_group_centroid,
    aes(
      mean_conc,
      mean_enrich,
      label = treatment,
      color = species
    ),
    size = 4,
    show.legend = FALSE
  ) +

  scale_color_manual(values = c("orange", "purple")) +
  scale_shape_manual(values = c(21, 24)) +

  theme_classic() +
  labs(
    x = "GS-GOGAT pathway concentration",
    y = "GS-GOGAT pathway 13C enrichment", 
    title = "GS-GOGAT Pathway"
  )
```



