---
title: "Larval P & R Plotting and Analysis - Moorea 2023" 
author: "AS Huffmyer"
date: '2023'
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 6
    toc_float: yes
  pdf_document:
    keep_tex: yes
editor_options: 
  chunk_output_type: console
---

# Setup  

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, warning=FALSE, message=FALSE}
## install packages if you dont already have them in your library
if ("tidyverse" %in% rownames(installed.packages()) == 'FALSE') install.packages('tidyverse') 
if ("car" %in% rownames(installed.packages()) == 'FALSE') install.packages('car') 
if ("lme4" %in% rownames(installed.packages()) == 'FALSE') install.packages('lme4') 
if ("lmerTest" %in% rownames(installed.packages()) == 'FALSE') install.packages('lmerTest') 
if ("scales" %in% rownames(installed.packages()) == 'FALSE') install.packages('scales') 
if ("cowplot" %in% rownames(installed.packages()) == 'FALSE') install.packages('cowplot') 
if ("ggplot2" %in% rownames(installed.packages()) == 'FALSE') install.packages('ggplot2') 
if ("effects" %in% rownames(installed.packages()) == 'FALSE') install.packages('effects') 
if ("emmeans" %in% rownames(installed.packages()) == 'FALSE') install.packages('emmeans') 
if ("multcomp" %in% rownames(installed.packages()) == 'FALSE') install.packages('multcomp') 
if ("rTPC" %in% rownames(installed.packages()) == 'FALSE') remotes::install_github("padpadpadpad/rTPC")
if ("ggstatsplot" %in% rownames(installed.packages()) == 'FALSE') remotes::install_github("IndrajeetPatil/ggstatsplot")
if ("nls.multstart" %in% rownames(installed.packages()) == 'FALSE') install.packages('nls.multstart')
if ("broom" %in% rownames(installed.packages()) == 'FALSE') install.packages('broom')

#load packages
library("ggplot2")
library("tidyverse")
library('car')
library('lme4')
library('lmerTest')
library('scales')
library('cowplot')
library('rTPC')
library('ggstatsplot')
library('nls.multstart')
library('broom')
library('emmeans')
```


# Data visualization and manipulation  

Load data from LoLinR.    
```{r, warning=FALSE, message=FALSE}
pr_data<-read.csv("output/larvae_sdr/larvae_calculated_normalized_photo_rates.csv") #load data
```

Format data. 
```{r, warning=FALSE, message=FALSE}
#remove all rows of wells that did not have samples or blanks
pr_data<-pr_data[!is.na(pr_data$Type),]

#format columns
pr_data$Species<-as.factor(pr_data$Species)
pr_data$SDR<-as.factor(pr_data$SDR)
pr_data$Plate<-as.factor(pr_data$Plate)
pr_data$Temperature<-as.factor(pr_data$Temperature)
```

Look for outliers in the data.  

```{r}
boxplot(pr_data$P.nmol.org.min)
#pi_temp_data<-pi_temp_data%>%filter(P.nmol.org.min < 0.10)
#boxplot(pi_temp_data$P.nmol.org.min)

boxplot(pr_data$P.nmol.org.min~pr_data$PAR*pr_data$Species)
```

Set values at 0 for light runs if <0 indicating no photosynthesis occurred. Set values at 0 for dark runs if >0 indicating no respiration occurred. 
```{r}
pr_data<-pr_data%>%
  mutate(P.nmol.org.min=if_else(Species=="Pocillopora" & P.nmol.org.min<0 & PAR==150, 0,
                              if_else(Species=="Pocillopora" & P.nmol.org.min>0 & PAR==0, 0,
                                    if_else(Species=="Acropora" & P.nmol.org.min>0, 0, P.nmol.org.min))))

boxplot(pr_data$P.nmol.org.min~pr_data$PAR*pr_data$Species)
```

Calculate mean temperature values for each run.    

```{r}
pr.temps<-read.csv("output/larvae_sdr/runs_temp.csv")
pr.temps = subset(pr.temps, select = -c(X) ) #remove empty column

pr_data$Plate<-as.integer(pr_data$Plate)
```

Add temperature data to master data frame.  
```{r}
pr_data<-left_join(pr_data,pr.temps)

#round to 0.1째C 
pr_data<-pr_data%>%
  mutate(Temp.C=round(Temp.C,1))

levels(as.factor(pr_data$Temp.C))
levels(as.factor(pr_data$Temperature))

pr.temps%>%group_by(Plate)%>%summarise(mean=mean(Temp.C))
```

Rename temperature categories. 
```{r}
pr_data<-pr_data%>%
  mutate(Temperature=if_else(Temperature=="27", "28.4", 
                           if_else(Temperature=="30", "29.4", 
                                   if_else(Temperature=="33", "31.5", NA))))

pr_data$Temperature
```

Reorder factor.  EDIT AS NEEDED 
```{r}
pr_data$PAR<-as.factor(pr_data$PAR)
pr_data$PAR
pr_data$Light<-as.factor(pr_data$Light)
pr_data$Light
```

# Plot and analyze ACR

Plot data with means 

Remove well 3-B1 - respiration rates were weird in the light (but worked in the dark). So remove for now and we can come back and replace the light period with the dark period as this sample did not reach oxygen depletion. 
```{r}
pr_data<-pr_data%>%
  filter(!unique=="3 - B1")
```

Acropora. 

Plot respiration rates only at 150 PAR. This is where respiration is taking place. By the time we get to the dark portion of the run oxygen is depleted and rates decrease. 
```{r}
pi_temp_plot1<-pr_data %>%
    filter(Species=="Acropora")%>%
    filter(PAR=="150")%>%
    group_by(PAR, Species, Temperature)%>%
    mutate(Temperature=as.factor(Temperature))%>%
    dplyr::summarise(mean=mean(P.nmol.org.min, na.rm=TRUE), sd=sd(P.nmol.org.min, na.rm=TRUE), N=length(P.nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = Temperature, y = -1*mean, group=interaction(PAR, Temperature))) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(PAR, Temperature), colour=Temperature), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=(-1*mean)-se, ymax=(-1*mean)+se, group=interaction(PAR, Temperature)), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Temperature (째C)") + 
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    scale_colour_manual(values=c("blue3", "orange", "darkred"))+
    #ylim(0, 0.05)+
    ggtitle("Acropora")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      title = element_text(size=14, face="bold")
      ); pi_temp_plot1

ggsave("figures/larvae_sdr/R_means_acr.png", pi_temp_plot1, dpi=300, w=4, h=4, units="in")
```

Plot with individual data points. 
```{r}
pi_temp_plot2<-pr_data %>%
    filter(Species=="Acropora")%>%
    filter(PAR=="150")%>%
    group_by(PAR, Species, Temperature)%>%
    mutate(Temperature=as.factor(Temperature))%>%
    
    ggplot(., aes(x = Temperature, y = -1*P.nmol.org.min, group=interaction(PAR, Temperature))) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=interaction(PAR, Temperature), colour=Temperature), size=3, position = position_jitterdodge(0.4)) + 
    xlab("Temperature (째C)") + 
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    scale_colour_manual(values=c("blue3", "orange", "darkred"))+
    #ylim(0, 0.05)+
    #geom_text(aes(label=unique))+
    ggtitle("Acropora")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      title = element_text(size=14, face="bold")
      ); pi_temp_plot2

ggsave("figures/larvae_sdr/pi_dots_acr.png", pi_temp_plot2, dpi=300, w=4, h=4, units="in")
```

# Plot and analyze POC

Plot data with means 

PAR 150 (light 1) = photosynthesis
PAR 0 (light 2)= LEDR 
```{r}
pi_temp_plot3<-pr_data %>%
    filter(Species=="Pocillopora")%>%
    group_by(PAR, Species, Temperature)%>%
    dplyr::summarise(mean=mean(P.nmol.org.min, na.rm=TRUE), sd=sd(P.nmol.org.min, na.rm=TRUE), N=length(P.nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = Temperature, y = mean, group=Temperature)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    facet_grid(~PAR, scales="free_y")+
    geom_point(aes(group=Temperature, colour=Temperature), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=(mean)-se, ymax=(mean)+se, group=Temperature), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Temperature") + 
    ylab(expression(bold(paste("Rate (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    scale_colour_manual(values=c("blue3", "orange", "darkred"))+
    #ylim(0, 0.05)+
    ggtitle("Pocillopora")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      title = element_text(size=14, face="bold")
      ); pi_temp_plot3

ggsave("figures/larvae_sdr/pi_means_poc.png", pi_temp_plot3, dpi=300, w=4, h=4, units="in")
```

Plot with individual data points. Outliers in R at ambient do not have any red flags - looks like true biological response.
```{r}
pi_temp_plot4<-pr_data %>%
    filter(Species=="Pocillopora")%>%
    group_by(PAR, Species, Temperature)%>%
    mutate(Temperature=as.factor(Temperature))%>%
    
    ggplot(., aes(x = as.factor(PAR), y = P.nmol.org.min, group=Temperature)) +
    facet_grid(~PAR, scales="free_y")+
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=Temperature, colour=Temperature), size=3, position = position_jitterdodge(0.4)) + 
    xlab("Temperature (째C)") + 
    ylab(expression(bold(paste("R (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    scale_colour_manual(values=c("blue3", "orange", "darkred"))+
    #ylim(0, 0.05)+
    ggtitle("Pocillopora")+
    theme_classic() + 
    #geom_text(aes(label=unique))+
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      title = element_text(size=14, face="bold")
      ); pi_temp_plot4

ggsave("figures/larvae_sdr/pi_dots_poc.png", pi_temp_plot4, dpi=300, w=4, h=4, units="in")
```

Plot separate P and R plots for Pocillopora 

```{r}
pi_temp_plot5<-pr_data %>%
    filter(Species=="Pocillopora")%>%
    filter(PAR=="0")%>%
    group_by(PAR, Species, Temperature)%>%
    dplyr::summarise(mean=mean(P.nmol.org.min, na.rm=TRUE), sd=sd(P.nmol.org.min, na.rm=TRUE), N=length(P.nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = Temperature, y = mean*-1, group=Temperature)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=Temperature, colour=Temperature), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=(mean*-1)-se, ymax=(mean*-1)+se, group=Temperature), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Temperature") + 
    ylab(expression(bold(paste("LEDR (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    scale_colour_manual(values=c("blue3", "orange", "darkred"))+
    #ylim(0, 0.05)+
    ggtitle("Pocillopora")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      title = element_text(size=14, face="bold")
      ); pi_temp_plot5

ggsave("figures/larvae_sdr/LEDR_means_poc.png", pi_temp_plot5, dpi=300, w=4, h=4, units="in")
```


```{r}
pi_temp_plot6<-pr_data %>%
    filter(Species=="Pocillopora")%>%
    filter(PAR=="150")%>%
    group_by(PAR, Species, Temperature)%>%
    dplyr::summarise(mean=mean(P.nmol.org.min, na.rm=TRUE), sd=sd(P.nmol.org.min, na.rm=TRUE), N=length(P.nmol.org.min), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = Temperature, y = mean, group=Temperature)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=Temperature, colour=Temperature), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=(mean)-se, ymax=(mean)+se, group=Temperature), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Temperature") + 
    ylab(expression(bold(paste("P (nmol ", O[2], " larva"^-1, "min"^-1, ")")))) +
    scale_colour_manual(values=c("blue3", "orange", "darkred"))+
    ylim(0, 0.002)+
    ggtitle("Pocillopora")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      title = element_text(size=14, face="bold")
      ); pi_temp_plot6

ggsave("figures/larvae_sdr/P_means_poc.png", pi_temp_plot6, dpi=300, w=4, h=4, units="in")
```

## Plot PR ratio for Pocillopora 

```{r}
pi_temp_plot7<-pr_data %>%
    filter(Species=="Pocillopora")%>%
    select(Species, PAR, Temperature, P.nmol.org.min, unique)%>%
    pivot_wider(names_from=PAR, values_from=P.nmol.org.min)%>%
    mutate(`0`=`0`*-1)%>%
    mutate(ratio=`150`/`0`)%>%
    group_by(Species, Temperature)%>%
    dplyr::summarise(mean=mean(ratio, na.rm=TRUE), sd=sd(ratio, na.rm=TRUE), N=length(ratio), se=sd/sqrt(N))%>%
    
    ggplot(., aes(x = Temperature, y = mean, group=Temperature)) +
    geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
    geom_point(aes(group=Temperature, colour=Temperature), size=6, position = position_dodge(0.4)) + 
    geom_errorbar(aes(ymin=(mean)-se, ymax=(mean)+se, group=Temperature), width=0, linetype="solid", position=position_dodge(0.4), size=0.8, color="black")+
    xlab("Temperature") + 
    ylab(expression(bold(paste("P:LEDR Ratio")))) +
    scale_colour_manual(values=c("blue3", "orange", "darkred"))+
    #ylim(0, 0.05)+
    ggtitle("Pocillopora")+
    theme_classic() + 
    theme(
      legend.position="none",
      axis.title=element_text(face="bold", size=16),
      axis.text=element_text(size=12, color="black"), 
      legend.title=element_text(face="bold", size=14), 
      legend.text=element_text(size=12), 
      title = element_text(size=14, face="bold")
      ); pi_temp_plot7

ggsave("figures/larvae_sdr/PR_ratio_means_poc.png", pi_temp_plot7, dpi=300, w=4, h=4, units="in")
```

# Panel of PR plots of both species 

```{r}
panel<-plot_grid(pi_temp_plot1, pi_temp_plot5, pi_temp_plot6, pi_temp_plot7, ncol=4, nrow=1)

ggsave("figures/larvae_sdr/all_PR_panel.png", panel, dpi=300, w=16, h=4, units="in")
```


# Conduct anova test 

Run anova on values at each temperature
```{r}
model<-pr_data%>%
  aov(P.nmol.org.min~PAR*Species*Temperature, data=.)

summary(model)
```
Interactions of PAR x Species x Temperature. 

Subset analysis for each species 

ACR respiration: 
```{r}
model_acr<-pr_data%>%
  filter(Species=="Acropora")%>%
  filter(PAR=="150")%>%
  aov(P.nmol.org.min~Temperature, data=.)

summary(model_acr)

emm<-emmeans(model_acr, ~Temperature)
pairs(emm)

```

Strong efffect of temperature on ACR respiration. 31.5 respiration is lower than that at other temperatures. 28.4 and 29.4 are not different. 

POC respiration: 
```{r}
model_poc_r<-pr_data%>%
  filter(Species=="Pocillopora")%>%
  filter(PAR=="0")%>%
  aov(P.nmol.org.min~Temperature, data=.)

summary(model_poc_r)

emm<-emmeans(model_poc_r, ~Temperature)
pairs(emm)

```

No effect of temperature on LEDR in Pocillopora - likely driven by variability in ambient group. 

POC photosynthesis: 
```{r}
model_poc_p<-pr_data%>%
  filter(Species=="Pocillopora")%>%
  filter(PAR=="150")%>%
  aov(P.nmol.org.min~Temperature, data=.)

summary(model_poc_p)

emm<-emmeans(model_poc_p, ~Temperature)
pairs(emm)

```

Temperature effects. Photosynthesis is lower at 31.5 than at 28.4. 

POC PR ratio: 
```{r}
model_poc_ratio<-pr_data %>%
    filter(Species=="Pocillopora")%>%
    select(Species, PAR, Temperature, P.nmol.org.min, unique)%>%
    pivot_wider(names_from=PAR, values_from=P.nmol.org.min)%>%
    mutate(`0`=`0`*-1)%>%
    mutate(ratio=`150`/`0`)%>%
  
    aov(ratio~Temperature, data=.)

summary(model_poc_ratio)

emm<-emmeans(model_poc_ratio, ~Temperature)
pairs(emm)
  
```
Effect of temperature on PR ratios. Lower at 31.5 than ambient. 
